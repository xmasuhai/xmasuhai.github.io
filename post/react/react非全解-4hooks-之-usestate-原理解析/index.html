<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>【React非全解 4】Hooks 之 UseState 原理解析 - Joel in The House</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Joel Xu" />
  <meta name="description" content="Hooks 之 useState 原理解析 大纲链接§ [toc] 逐步分析 useState 基本原理和源码近似实现 1. 最简单的 useState 实现 ⇧ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 function App() { console.log(&amp;#39;App 运行了&amp;#39;) const [n, setN] = useState(0)" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.91.2" />


<link rel="canonical" href="http://xmasuhai.xyz/post/react/react%E9%9D%9E%E5%85%A8%E8%A7%A3-4hooks-%E4%B9%8B-usestate-%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="【React非全解 4】Hooks 之 UseState 原理解析" />
<meta property="og:description" content="Hooks 之 useState 原理解析 大纲链接§ [toc] 逐步分析 useState 基本原理和源码近似实现 1. 最简单的 useState 实现 ⇧ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 function App() { console.log(&#39;App 运行了&#39;) const [n, setN] = useState(0)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://xmasuhai.xyz/post/react/react%E9%9D%9E%E5%85%A8%E8%A7%A3-4hooks-%E4%B9%8B-usestate-%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-10-05T01:19:24+08:00" />
<meta property="article:modified_time" content="2022-10-10T22:21:47+08:00" />

<meta itemprop="name" content="【React非全解 4】Hooks 之 UseState 原理解析">
<meta itemprop="description" content="Hooks 之 useState 原理解析 大纲链接§ [toc] 逐步分析 useState 基本原理和源码近似实现 1. 最简单的 useState 实现 ⇧ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 function App() { console.log(&#39;App 运行了&#39;) const [n, setN] = useState(0)"><meta itemprop="datePublished" content="2022-10-05T01:19:24+08:00" />
<meta itemprop="dateModified" content="2022-10-10T22:21:47+08:00" />
<meta itemprop="wordCount" content="3777">
<meta itemprop="keywords" content="FrontEnd,React," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="【React非全解 4】Hooks 之 UseState 原理解析"/>
<meta name="twitter:description" content="Hooks 之 useState 原理解析 大纲链接§ [toc] 逐步分析 useState 基本原理和源码近似实现 1. 最简单的 useState 实现 ⇧ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 function App() { console.log(&#39;App 运行了&#39;) const [n, setN] = useState(0)"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Joel in The House</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/post/">文档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/categories/">目录</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/about/">关于我</a>
          
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Joel in The House
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/post/">文档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/categories/">目录</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/about/">关于我</a>
          

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">【React非全解 4】Hooks 之 UseState 原理解析</h1>
      
      <div class="post-meta">
        <time datetime="2022-10-05" class="post-time">
          2022-10-05
        </time>
        <div class="post-category">
            <a href="http://xmasuhai.xyz/categories/react/"> React </a>
            
          </div>
        <span class="more-meta"> 约 3777 字 </span>
          <span class="more-meta"> 预计阅读 8 分钟 </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#1-最简单的-usestate-实现-a-hrefcatalogue--a">1. 最简单的 <code>useState</code> 实现 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></a></li>
    <li><a href="#2-如何让两个-usestate-不冲突-a-hrefcatalogue--a">2. 如何让两个 <code>useState</code> 不冲突 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></a></li>
    <li><a href="#3-usestate-不能写在-if-条件判断语句里-a-hrefcatalogue--a">3. <code>useState</code> 不能写在 <code>if</code> 条件判断语句里 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></a>
      <ul>
        <li><a href="#usestate小结"><code>useState</code>小结</a></li>
      </ul>
    </li>
    <li><a href="#使用-useref-和-usecontext解决-数据状态分身问题-a-hrefcatalogue--a">使用 <code>useRef</code> 和 <code>useContext</code>解决 数据状态分身问题 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></a>
      <ul>
        <li><a href="#useref-的一个作用固定数据状态-a-hrefcatalogue--a"><code>useRef</code> 的一个作用：固定数据状态 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></a></li>
        <li><a href="#usecontext-的作用-a-hrefcatalogue--a"><code>useContext</code> 的作用 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></a></li>
      </ul>
    </li>
    <li><a href="#总结-a-hrefcatalogue--a">总结 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></a></li>
    <li><a href="#参考文章-a-hrefcatalogue--a">参考文章 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></a></li>
    <li><a href="#相关文章-a-hrefcatalogue--a">相关文章 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></a></li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h1 id="hooks-之-usestate-原理解析"><code>Hooks</code> 之 <code>useState</code> 原理解析</h1>
<blockquote>
<p>大纲链接<!-- raw HTML omitted --> § <!-- raw HTML omitted --></p>
</blockquote>
<p>[toc]</p>
<hr>
<blockquote>
<p>逐步分析 <code>useState</code> 基本原理和源码近似实现</p>
</blockquote>
<h2 id="1-最简单的-usestate-实现-a-hrefcatalogue--a">1. 最简单的 <code>useState</code> 实现 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="kd">function</span> <span class="nx">App</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;App 运行了&#39;</span><span class="p">)</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">n</span><span class="p">,</span> <span class="nx">setN</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`n: </span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&#34;app&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">n</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="nx">setN</span><span class="p">(</span><span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}&gt;</span><span class="o">+</span><span class="mi">1</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(&lt;</span><span class="nt">App</span> <span class="p">/&gt;,</span> <span class="nx">rootElement</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>脑补点击<code>button</code>会发生什么</p>
</blockquote>
<ul>
<li>首次渲染 <code>render &lt;App /&gt;</code>
<ul>
<li>调用<code>App</code>函数，得到虚拟<code>div</code>，创建真实<code>div</code></li>
</ul>
</li>
<li>用户点击<code>button</code>按钮，调用<code>setN(n + 1)</code>，再次 <code>render &lt;App /&gt;</code>
<ul>
<li>调用<code>App</code>函数，得到虚拟<code>div</code>，经过<code>DOM Diff</code>，局部更新真实<code>div</code></li>
</ul>
</li>
<li>每次调用<code>App()</code>，都会运行<code>useState(0)</code>？
<ul>
<li>第<code>n</code>次运行<code>useState</code>，每次得到的<code>n</code>并不相同</li>
</ul>
</li>
<li><code>useState</code>如何实现每次运行时，得到<code>n</code>的结果不一样？</li>
</ul>
<blockquote>
<p>脑补点击<code>button</code>会发生什么</p>
</blockquote>
<ul>
<li>执行<code>setN</code>的时候，会发生什么？<code>n</code>会变吗？<code>App()</code>会重新执行吗？</li>
<li>如果<code>App()</code>会重新执行，那么<code>useState(0)</code>的时候 ，<code>n</code>每次的值会有不同吗？</li>
<li>通过<code>console.log</code>可以得出答案
<ul>
<li><code>App()</code>会重新执行</li>
<li><code>setN</code>并不会改变<code>state.n</code>本身</li>
<li><code>n</code>的值会改变</li>
</ul>
</li>
</ul>
<blockquote>
<p>分析推论</p>
</blockquote>
<ul>
<li><code>setN</code>
<ul>
<li><code>setN</code>一定会修改数据<code>x</code>，将<code>n + 1</code>存入<code>x</code>
<ul>
<li>而不是直接赋值给原数据<code>n</code></li>
</ul>
</li>
<li><code>setN</code>一定会触发<code>&lt;App /&gt;</code>重新渲染<code>re-render</code></li>
</ul>
</li>
<li><code>useState</code>
<ul>
<li><code>useState</code>一定会从<code>x</code>读取<code>n</code>的 <strong>最新值</strong></li>
</ul>
</li>
<li><code>x</code>
<ul>
<li>每个组件有自己的数据<code>x</code>，将其命名为<code>state</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>尝试实现 <code>React.useState</code></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">&#39;react&#39;</span>
<span class="kr">import</span> <span class="nx">ReactDOM</span> <span class="nx">from</span> <span class="s1">&#39;react-dom&#39;</span>
<span class="kr">const</span> <span class="nx">rootElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">myUseState</span><span class="p">(</span><span class="nx">initialValue</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;myUseState运行&#39;</span><span class="p">)</span>
  <span class="kd">let</span> <span class="nx">_state</span> <span class="o">=</span> <span class="nx">initialValue</span>

  <span class="kd">function</span> <span class="nx">setState</span><span class="p">(</span><span class="nx">newState</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_state</span> <span class="o">=</span> <span class="nx">newState</span>
    <span class="nx">render</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">_state</span><span class="p">,</span> <span class="nx">setState</span><span class="p">]</span>
<span class="p">}</span>
<span class="c1">// 借用ReactDOM.render
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">render</span> <span class="o">=</span> <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(&lt;</span><span class="nt">App</span> <span class="p">/&gt;,</span> <span class="nx">roootElement</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">App</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;App运行&#39;</span><span class="p">)</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">n</span><span class="p">,</span> <span class="nx">setN</span><span class="p">]</span> <span class="o">=</span> <span class="nx">myUseState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`n: </span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&#34;App&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">n</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="nx">setN</span><span class="p">(</span><span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}</span><span class="o">&gt;+</span><span class="mi">1</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="na">ReactDOM.render</span><span class="err">(&lt;</span><span class="na">App</span> <span class="p">/&gt;,</span> <span class="nx">rootElement</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>点击按钮，视图不更新，打印<code>n</code>没有变化</li>
<li>因为每次运行<code>myUseState</code>会将<code>state</code>重置</li>
<li>需要一个不会被<code>myUseState</code>重置的变量</li>
<li>利用闭包，将变量声明在<code>myUseState</code>外部</li>
</ul>
<blockquote>
<p>再次尝试实现 <code>React.useState</code></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">&#39;react&#39;</span>
<span class="kr">import</span> <span class="nx">ReactDOM</span> <span class="nx">from</span> <span class="s1">&#39;react-dom&#39;</span>
<span class="kr">const</span> <span class="nx">rootElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">_state</span>
<span class="kd">function</span> <span class="nx">myUseState</span><span class="p">(</span><span class="nx">initialValue</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;myUseState运行&#39;</span><span class="p">)</span>
  <span class="c1">// _state = _state === undefined ? initialValue : _state
</span><span class="c1"></span>  <span class="c1">// _state = _state || initialValue // 有0值判断的bug
</span><span class="c1"></span>  <span class="nx">_state</span> <span class="o">=</span> <span class="nx">_state</span> <span class="o">??</span> <span class="nx">initialValue</span> <span class="c1">// 空值合并运算符 保证常量不为 null 或者 undefined
</span><span class="c1"></span>
  <span class="kd">function</span> <span class="nx">setState</span><span class="p">(</span><span class="nx">newSstate</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_state</span> <span class="o">=</span> <span class="nx">newState</span>
    <span class="nx">render</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">_state</span><span class="p">,</span> <span class="nx">setState</span><span class="p">]</span>
<span class="p">}</span>
<span class="c1">// 借用ReactDOM.render
</span><span class="c1"></span><span class="kr">const</span> <span class="nx">render</span> <span class="o">=</span> <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(&lt;</span><span class="nt">App</span> <span class="p">/&gt;,</span> <span class="nx">roootElement</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">App</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;App运行&#39;</span><span class="p">)</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">n</span><span class="p">,</span> <span class="nx">setN</span><span class="p">]</span> <span class="o">=</span> <span class="nx">myUseState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`n: </span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&#34;App&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">n</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="nx">setN</span><span class="p">(</span><span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}</span><span class="o">&gt;+</span><span class="mi">1</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="na">ReactDOM.render</span><span class="err">(&lt;</span><span class="na">App</span> <span class="p">/&gt;,</span> <span class="nx">rootElement</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>以上代码存在的问题：如果一个组件用了 <a href="https://codesandbox.io/s/fervent-water-jvyro">两个 <code>useState</code></a> 怎么办</p>
</blockquote>
<hr>
<h2 id="2-如何让两个-usestate-不冲突-a-hrefcatalogue--a">2. 如何让两个 <code>useState</code> 不冲突 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></h2>
<ul>
<li>由于所有数据都放在同一个 <code>_state</code> 中，所以会冲突</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s2">&#34;react&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">ReactDOM</span> <span class="nx">from</span> <span class="s2">&#34;react-dom&#34;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">rootElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;root&#34;</span><span class="p">);</span>

<span class="kd">let</span> <span class="nx">_state</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">myUseState</span><span class="p">(</span><span class="nx">initialValue</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">_state</span> <span class="o">=</span> <span class="nx">_state</span> <span class="o">||</span> <span class="nx">initialValue</span><span class="p">;</span>
  <span class="kd">function</span> <span class="nx">setState</span><span class="p">(</span><span class="nx">newState</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_state</span> <span class="o">=</span> <span class="nx">newState</span><span class="p">;</span>
    <span class="nx">render</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">_state</span><span class="p">,</span> <span class="nx">setState</span><span class="p">];</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">render</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(&lt;</span><span class="nt">App</span> <span class="p">/&gt;,</span> <span class="nx">rootElement</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">App</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">n</span><span class="p">,</span> <span class="nx">setN</span><span class="p">]</span> <span class="o">=</span> <span class="nx">myUseState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">m</span><span class="p">,</span> <span class="nx">setM</span><span class="p">]</span> <span class="o">=</span> <span class="nx">myUseState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&#34;App&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">n</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="nx">setN</span><span class="p">(</span><span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}&gt;</span><span class="o">+</span><span class="mi">1</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">m</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="nx">setM</span><span class="p">(</span><span class="nx">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}&gt;</span><span class="o">+</span><span class="mi">1</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(&lt;</span><span class="nt">App</span> <span class="p">/&gt;,</span> <span class="nx">rootElement</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>改进思路</p>
</blockquote>
<ul>
<li>把<code>_state</code>做成一个对象
<ul>
<li>比如<code>_state = {n: 0, m: 0}</code></li>
<li>不行，因为<code>useState(0)</code>并不知道变量的命名，是<code>n</code>还是<code>m</code></li>
</ul>
</li>
<li>把<code>_state</code>做成数组
<ul>
<li>比如<code>_state = [0, 0]</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>使用多个<code>useState</code></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="kd">let</span> <span class="nx">_state</span> <span class="o">=</span> <span class="p">[]</span>
<span class="kd">let</span> <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span>

<span class="kd">function</span> <span class="nx">myUseState</span><span class="p">(</span><span class="nx">initialValue</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">currentIndex</span> <span class="o">=</span> <span class="nx">index</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;currentIndex&#39;</span><span class="p">,</span> <span class="nx">currentIndex</span><span class="p">)</span>
  <span class="nx">index</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="c1">// 等价于 // _state[currentIndex] = _state[currentIndex] === undefined ? initialValue : _state[currentIndex]
</span><span class="c1"></span>  <span class="nx">_state</span><span class="p">[</span><span class="nx">currentIndex</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_state</span><span class="p">[</span><span class="nx">currentIndex</span><span class="p">]</span> <span class="o">??</span> <span class="nx">initialValue</span>
  <span class="kr">const</span> <span class="nx">setState</span> <span class="o">=</span> <span class="nx">newState</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span>
    <span class="nx">_state</span><span class="p">[</span><span class="nx">currentIndex</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newState</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;_state&#39;</span><span class="p">,</span> <span class="nx">_state</span><span class="p">)</span>
    <span class="nx">render</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">_state</span><span class="p">[</span><span class="nx">currentIndex</span><span class="p">],</span> <span class="nx">setState</span><span class="p">]</span>
<span class="p">}</span>

<span class="kr">const</span> <span class="nx">render</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">// 重置index 防止每次渲染不断向_state中添加
</span><span class="c1"></span>  <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(&lt;</span><span class="nt">App</span> <span class="p">/&gt;,</span> <span class="nx">rootElement</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">App</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">n</span><span class="p">,</span> <span class="nx">setN</span><span class="p">]</span> <span class="o">=</span> <span class="nx">myUseState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">m</span><span class="p">,</span> <span class="nx">setM</span><span class="p">]</span> <span class="o">=</span> <span class="nx">myUseState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&#34;App&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">n</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="nx">setN</span><span class="p">(</span><span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}&gt;</span><span class="o">+</span><span class="mi">1</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">m</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="nx">setM</span><span class="p">(</span><span class="nx">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}&gt;</span><span class="o">+</span><span class="mi">1</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(&lt;</span><span class="nt">App</span> <span class="p">/&gt;,</span> <span class="nx">rootElement</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><a href="https://codesandbox.io/s/clever-pine-2fl7n">代码示例</a>，注意<code>index += 1</code>、<code>currentIndex</code>和 在渲染方法中重置<code>index = 0</code></li>
<li>不可以直接使用<code>index</code>，需要先使用中间变量保存下<code>currentIndex</code>
<ul>
<li><code>index</code>闭包变量，<code>index += 1</code> 用来累计加一</li>
</ul>
</li>
<li>这样会导致 <code>_state</code> 越来越长，每次运行<code>App</code>，<code>index</code>没有被重置</li>
<li>理论上在每次渲染<code>App</code>前，就应该重置<code>index = 0</code>
<ul>
<li>防止每次渲染不断向<code>_state</code>数组中添加新项，而不是修改对应值</li>
</ul>
</li>
</ul>
<hr>
<h2 id="3-usestate-不能写在-if-条件判断语句里-a-hrefcatalogue--a">3. <code>useState</code> 不能写在 <code>if</code> 条件判断语句里 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></h2>
<blockquote>
<p><code>_state</code>数组方案缺点：<code>if</code>可能会打乱调用顺序</p>
</blockquote>
<ul>
<li><code>useState</code>调用顺序
<ul>
<li>若第一次渲染时，<code>n</code>是第一个，<code>m</code>是第二个，<code>k</code>是第三个</li>
<li>则第二次渲染时必须保证调用顺序完全一致，不能跳过，颠倒顺序，否则数据就乱了</li>
</ul>
</li>
</ul>
<blockquote>
<p><code>React</code>不允许出现如下代码，<a href="https://codesandbox.io/s/silly-albattani-j6y72">查看报错</a></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="c1">// ...
</span><span class="c1"></span><span class="kd">function</span> <span class="nx">App</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">n</span><span class="p">,</span> <span class="nx">setN</span><span class="p">]</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="kd">let</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">setM</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">n</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// if 打乱了调用顺序
</span><span class="c1"></span>    <span class="kr">const</span> <span class="p">[</span><span class="nx">m</span><span class="p">,</span> <span class="nx">setM</span><span class="p">]</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// 此时如果还有一个数据k，就会被提前到第二的位置
</span><span class="c1"></span>  <span class="c1">// const [k, setK] = React.useState(0);
</span><span class="c1"></span>  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&#34;App&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">n</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="nx">setN</span><span class="p">(</span><span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}&gt;</span><span class="o">+</span><span class="mi">1</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">m</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="nx">setM</span><span class="p">(</span><span class="nx">m</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}&gt;</span><span class="o">+</span><span class="mi">1</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>
<span class="c1">// ...
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>报错 <code>React Hook &quot;React.useState&quot; is called conditionally. React Hooks must be called in the exact same order in every component render. </code></li>
<li>点击后报错：</li>
</ul>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB29619c82321d640473a5792587736ca3?method=download&amp;shareKey=520459779bd5ee8426a884b74057c3c2" alt="useStateOrder"></p>
<ul>
<li>参考 <a href="https://mp.weixin.qq.com/s?__biz=MzIxNzUzOTk1MQ==&amp;mid=2247484037&amp;idx=1&amp;sn=3b676d50b0ceb5bf11d8876f3b07b77d&amp;chksm=97f97685a08eff9356ac331c127d0ec64565dd00521656981d79925c25056519133829591f79&amp;cur_album_id=2291981265736302593&amp;scene=190#rd">React 源码赏析一则</a></li>
<li>另一个原因是<code>JS</code>本身就不建议在条件语句中声明变量</li>
<li><code>Vue3</code> 使用另一种思路解决了这个问题&hellip;</li>
</ul>
<hr>
<blockquote>
<p>代码中还存在两个问题</p>
</blockquote>
<ul>
<li><code>App</code>用了<code>_state</code>和<code>index</code>，那其他组件用什么
<ul>
<li>解决办法：给每个组件，创建一个<code>_state</code>和<code>index</code></li>
</ul>
</li>
<li>放在全局作用域里重名怎么办
<ul>
<li>解决办法：放在组件对应 虚拟节点对象上</li>
</ul>
</li>
</ul>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB6a1d316041ab7dea7dc8b235991178fb?method=download&amp;shareKey=57b7f5e8f4bca944436a84bd5914e6cf" alt="useState原理图示"></p>
<ul>
<li>上图只画了<code>App</code>组件的更新过程，两个<code>ChildA</code>组件也有同样的过程</li>
<li>每个组件节点都会使用自己独立的<code>_state</code>和<code>index</code></li>
</ul>
<hr>
<h3 id="usestate小结"><code>useState</code>小结</h3>
<ul>
<li>每个函数组件对应一个<code>React</code>节点<code>*</code>
<ul>
<li><code>*</code>注意：目前代码对<code>React</code>的实现做了简化：
<ul>
<li><code>React</code>节点应该是<code>FiberNode</code></li>
<li><code>_state</code>的真实名称为<code>memorizedState</code></li>
<li><code>index</code>的实现则用到了链表</li>
</ul>
</li>
</ul>
</li>
<li>每个节点保存着各自的<code>state</code>和<code>index</code></li>
<li><code>useState</code>会读取<code>state[index]</code></li>
<li><code>index</code>由<code>useState</code>出现的顺序决定</li>
<li><code>setState</code>会修改<code>state</code>，并触发更新</li>
</ul>
<blockquote>
<p>参考</p>
</blockquote>
<ul>
<li><a href="https://juejin.cn/post/6844903704437456909">阅读源码后，来讲讲React Hooks是怎么实现的</a></li>
</ul>
<hr>
<hr>
<h2 id="使用-useref-和-usecontext解决-数据状态分身问题-a-hrefcatalogue--a">使用 <code>useRef</code> 和 <code>useContext</code>解决 数据状态分身问题 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></h2>
<blockquote>
<p>在使用<code>useState</code>过程中的错误理解：<code>setN(n + 1)</code>会改变<code>n</code></p>
</blockquote>
<ul>
<li>数据状态中 <code>n</code>的分身，<a href="https://codesandbox.io/s/fancy-fast-qh4yd">代码示例</a></li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="kd">function</span> <span class="nx">App</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">n</span><span class="p">,</span> <span class="nx">setN</span><span class="p">]</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useState</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
  <span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`n: </span><span class="si">${</span><span class="nx">n</span><span class="si">}</span><span class="sb">`</span><span class="p">),</span> <span class="mi">3000</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&#34;App&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">n</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onCLick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="nx">setN</span><span class="p">(</span><span class="nx">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)}&gt;</span><span class="o">+</span><span class="mi">1</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onCLick</span><span class="o">=</span><span class="p">{</span><span class="nx">log</span><span class="p">}&gt;</span><span class="nx">log</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>两种操作，为什么<code>log</code>出了旧数据？</p>
</blockquote>
<ul>
<li>1.点击<code>+1</code>，再点击<code>log</code>：无<code>bug</code></li>
<li>2.点击<code>log</code>，再点击<code>+1</code>：有<code>bug</code></li>
</ul>
<blockquote>
<p>因为有多个<code>n</code>，见时序图</p>
</blockquote>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB1141cca798d84dac0e7862b9974c6ba4?method=download&amp;shareKey=fe543c14a6b86452a2c96848610406c1" alt="多个n"></p>
<ul>
<li><code>setN(n + 1)</code>永不会改变<code>n</code></li>
<li>每次<code>setN(n + 1)</code>就会产生函数作用域内新的<code>n</code>，和旧的<code>n</code>同时存在与内存中</li>
<li>类似经典问题在<code>for</code>循环中打印5个5</li>
</ul>
<hr>
<blockquote>
<p>希望有一个贯穿始终的状态</p>
</blockquote>
<ul>
<li>使用全局变量：<code>window.xxx</code>不实用</li>
<li>使用<code>useRef</code>
<ul>
<li><code>useRef</code>不仅可用于普通节点<code>div</code>，还能用于任意数据</li>
<li><a href="https://codesandbox.io/s/flamboyant-elion-jvtl2"><code>useRef</code>的示例</a></li>
<li><a href="https://codesandbox.io/s/vibrant-sunset-f1lld">强制更新（追加更新<code>update(nRef.current)</code>）的示例</a>（不推荐使用，不如去使用<code>Vue3</code>）</li>
</ul>
</li>
<li>使用<code>useContext</code>
<ul>
<li><code>useContext</code>不仅能贯穿始终，还能贯穿不同组件</li>
<li><a href="https://codesandbox.io/s/wizardly-grothendieck-ek0i5"><code>useContext</code>的示例</a></li>
</ul>
</li>
</ul>
<h3 id="useref-的一个作用固定数据状态-a-hrefcatalogue--a"><code>useRef</code> 的一个作用：固定数据状态 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s2">&#34;react&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">ReactDOM</span> <span class="nx">from</span> <span class="s2">&#34;react-dom&#34;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">rootElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;root&#34;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">App</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">nRef</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useRef</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// 类似对象的引用 {current: 0}
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`n: </span><span class="si">${</span><span class="nx">nRef</span><span class="p">.</span><span class="nx">current</span><span class="si">}</span><span class="sb">`</span><span class="p">),</span> <span class="mi">1000</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&#34;App&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">nRef</span><span class="p">.</span><span class="nx">current</span><span class="p">}</span> <span class="nx">这里并不能实时更新</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">nRef</span><span class="p">.</span><span class="nx">current</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)}&gt;</span><span class="o">+</span><span class="mi">1</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">log</span><span class="p">}&gt;</span><span class="nx">log</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(&lt;</span><span class="nt">App</span> <span class="p">/&gt;,</span> <span class="nx">rootElement</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>const nRef = React.useRef(0);</code> // 类似对象的引用 <code>{current: 0}</code></li>
<li>读取值 <code>nRef.current</code>
<ul>
<li>类似<code>Vue3</code>的<code>ref</code>响应式数据读取值需要<code>.value</code></li>
</ul>
</li>
<li>有一个<code>bug</code>是：当<code>nRef.current += 1</code>时改变了原来的值，但不会自动重新渲染<code>App</code>，因为不符合 「函数式」</li>
</ul>
<blockquote>
<p>可以手动触发<code>App</code>更新</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s2">&#34;react&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">ReactDOM</span> <span class="nx">from</span> <span class="s2">&#34;react-dom&#34;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">rootElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;root&#34;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">App</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">nRef</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useRef</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// 类似对象的引用 {current: 0}
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`n: </span><span class="si">${</span><span class="nx">nRef</span><span class="p">.</span><span class="nx">current</span><span class="si">}</span><span class="sb">`</span><span class="p">),</span> <span class="mi">1000</span><span class="p">);</span>

  <span class="c1">// 手动触发`App`更新
</span><span class="c1"></span>  <span class="c1">// const [n, setN] = React.useState(null)
</span><span class="c1"></span>  <span class="c1">// const setN = React.useState(null)[1]
</span><span class="c1"></span>  <span class="kr">const</span> <span class="nx">update</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useState</span><span class="p">(</span><span class="kc">null</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="s">&#34;App&#34;</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">nRef</span><span class="p">.</span><span class="nx">current</span><span class="p">}</span> <span class="nx">这里并不能实时更新</span><span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{</span>
          <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
            <span class="nx">nRef</span><span class="p">.</span><span class="nx">current</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c1">// setN(nRef.current)
</span><span class="c1"></span>            <span class="nx">update</span><span class="p">(</span><span class="nx">nRef</span><span class="p">.</span><span class="nx">current</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}&gt;</span><span class="o">+</span><span class="mi">1</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">log</span><span class="p">}&gt;</span><span class="nx">log</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(&lt;</span><span class="nt">App</span> <span class="p">/&gt;,</span> <span class="nx">rootElement</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>一直使用同一个对象<code>nRef</code>解决<code>bug</code></li>
</ul>
<hr>
<h3 id="usecontext-的作用-a-hrefcatalogue--a"><code>useContext</code> 的作用 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></h3>
<blockquote>
<p>实现切换主题的功能</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-jsx" data-lang="jsx"><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s2">&#34;react&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">ReactDOM</span> <span class="nx">from</span> <span class="s2">&#34;react-dom&#34;</span><span class="p">;</span>
<span class="kr">import</span> <span class="s2">&#34;./styles.css&#34;</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">rootElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&#34;root&#34;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">themeContext</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createContext</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span> <span class="c1">// 初始化上下文，即全局变量
</span><span class="c1"></span>
<span class="kd">function</span> <span class="nx">App</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">[</span><span class="nx">theme</span><span class="p">,</span> <span class="nx">setTheme</span><span class="p">]</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useState</span><span class="p">(</span><span class="s2">&#34;red&#34;</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">themeContext.Provider</span> <span class="na">value</span><span class="o">=</span><span class="p">{{</span> <span class="nx">theme</span><span class="p">,</span> <span class="nx">setTheme</span> <span class="p">}}&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className</span><span class="o">=</span><span class="p">{</span><span class="sb">`App </span><span class="si">${</span><span class="nx">theme</span><span class="si">}</span><span class="sb">`</span><span class="p">}&gt;</span>
        <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;{</span><span class="nx">theme</span><span class="p">}&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">ChildA</span> <span class="p">/&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">ChildB</span> <span class="p">/&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">themeContext.Provider</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">ChildA</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">setTheme</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useContext</span><span class="p">(</span><span class="nx">themeContext</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="nx">setTheme</span><span class="p">(</span><span class="s2">&#34;red&#34;</span><span class="p">)}&gt;</span><span class="nx">red</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">ChildB</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="p">{</span> <span class="nx">setTheme</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">useContext</span><span class="p">(</span><span class="nx">themeContext</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick</span><span class="o">=</span><span class="p">{()</span> <span class="p">=&gt;</span> <span class="nx">setTheme</span><span class="p">(</span><span class="s2">&#34;blue&#34;</span><span class="p">)}&gt;</span><span class="nx">blue</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(&lt;</span><span class="nt">App</span> <span class="p">/&gt;,</span> <span class="nx">rootElement</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>初始化上下文，即全局变量<code>const themeContext = React.createContext(null);</code></li>
<li><code>themeContext.Provider</code>表示作用域范围，在标签内<code>&lt;themeContext.Provider&gt;...&lt;/themeContext.Provider&gt;</code>
<ul>
<li>只有此作用域里的组件（子孙组件）可以使用提供的数据 <code>value={{ theme, setTheme }}</code></li>
</ul>
</li>
<li>在子组件中读取<code>const { setTheme } = React.useContext(themeContext);</code>，即子孙组件调用父组件提供的全局方法</li>
</ul>
<hr>
<h2 id="总结-a-hrefcatalogue--a">总结 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></h2>
<ul>
<li>每次重新渲染，组件函数就会执行</li>
<li>对应所有<code>state</code>都会出现数据的「分身」</li>
<li>可以使用<code>useRef/useContext</code>，来得到符合预期的数据</li>
</ul>
<hr>
<blockquote>
<p><code>Vue 3</code> 对比 <code>React</code></p>
</blockquote>
<hr>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<hr>
<h2 id="参考文章-a-hrefcatalogue--a">参考文章 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></h2>
<ul>
<li>讲义下载：<a href="https://static.xiedaimala.com/xdml/file/3ac7c224-c23d-491f-84b5-4fabfbeab9b8/2020-3-24-9-43-8.pdf">React useState 原理.pdf</a></li>
<li>扩展阅读：<a href="https://mp.weixin.qq.com/s/flyEm1r2x0cr8bni1mMQGQ">React 源码赏析一则</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2019/09/react-hooks.html">React Hooks 入门教程 阮一峰</a></li>
<li><a href="https://github.com/brickspert/blog">brickspert/blog 我的技术博客 React的最新相关文章</a></li>
</ul>
<blockquote>
<p>亮点</p>
</blockquote>
<ol>
<li>分析 useState 原理和源码</li>
<li>useRef 的作用</li>
<li>useContext 的作用</li>
</ol>
<h2 id="相关文章-a-hrefcatalogue--a">相关文章 <!-- raw HTML omitted --> ⇧ <!-- raw HTML omitted --></h2>
<ul>
<li><a href="https://github.com/brickspert/blog/issues/26">React Hooks 原理</a></li>
<li><a href="https://juejin.cn/post/6844903701069430797">Jokcy的React分享</a></li>
</ul>
<hr>
<ul>
<li>作者： Joel</li>
<li>文章链接：</li>
<li><a href="http://xmasuhai.xyz/posts/%E7%89%88%E6%9D%83%E5%A3%B0%E6%98%8E%E9%93%BE%E6%8E%A5/">版权声明</a></li>
<li>非自由转载-非商用-非衍生-保持署名</li>
</ul>
<hr>
<hr>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Joel Xu</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2022-10-10
      
        
        
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="http://xmasuhai.xyz/tags/frontend/">FrontEnd</a>
          <a href="http://xmasuhai.xyz/tags/react/">React</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/react/react%E9%9D%9E%E5%85%A8%E8%A7%A3-5hooks-%E5%90%84%E4%B8%AA%E5%87%BB%E7%A0%B4/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">【React非全解 5】React 内置 Hooks 各个击破</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/react/react%E9%9D%9E%E5%85%A8%E8%A7%A3-3%E5%87%BD%E6%95%B0%E7%BB%84%E4%BB%B6/">
            <span class="next-text nav-default">【React非全解 3】函数组件</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

  

  
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:xmasuhai@163.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/xmasuhai" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://www.zhihu.com/people/xue-shou-41/posts" rel="me noopener" class="iconfont"
      title="zhihu"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M351.791182 562.469462l192.945407 0c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262l159.282726 0c0 0-0.86367-67.402109-18.578124-67.402109s-279.979646 0-279.979646 0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461c-4.536316 12.313443 24.62791 5.832845 36.941354 0 12.313443-5.832845 68.050885-25.924439 84.252893-103.69571l86.570681 0c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262L109.86113 490.530013c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449L279.868105 562.469462c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513 0 0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-0.055259 0.185218 167.855986 193.263655c0 0 22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-0.045025 0.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"></path>
  <path d="M584.918753 182.033893l0 668.840094 70.318532 0 28.807093 80.512708 121.875768-80.512708 153.600307 0L959.520453 182.033893 584.918753 182.033893zM887.150192 778.934538l-79.837326 0-99.578949 65.782216-23.537066-65.782216-24.855084 0L659.341766 256.673847l227.807403 0L887.149169 778.934538z"></path>
</svg>

    </a>


<a href="http://xmasuhai.xyz/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2019 -
    2022
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Joel Xu
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
