<!DOCTYPE html>
<html lang="zh-cn" itemscope itemtype="http://schema.org/WebPage">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>【JS异步非全解04】事件循环机制与浏览器EventLoop - Joel in The House</title>
  

<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes"/>

<meta name="MobileOptimized" content="width"/>
<meta name="HandheldFriendly" content="true"/>


<meta name="applicable-device" content="pc,mobile">

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="mobile-web-app-capable" content="yes">

<meta name="author" content="Joel Xu" />
  <meta name="description" content="事件循环机制EventLoop Event Loop 即事件循环，是浏览器或Node解决单线程运行不阻塞的一种机制 大纲链接§ [toc] 进程和线程 浏览器打开一个页面就相当" />

  <meta name="keywords" content="Hugo, theme, jane" />






<meta name="generator" content="Hugo 0.91.2" />


<link rel="canonical" href="http://xmasuhai.xyz/post/promise/js%E5%BC%82%E6%AD%A5%E9%9D%9E%E5%85%A8%E8%A7%A304%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E6%9C%BA%E5%88%B6%E4%B8%8E%E6%B5%8F%E8%A7%88%E5%99%A8eventloop/" />





<link rel="icon" href="/favicon.ico" />











<link rel="stylesheet" href="/sass/jane.min.af20b78e95c84de86b00a0242a4a77bd2601700e1b250edf27537d957ac0041d.css" integrity="sha256-ryC3jpXITehrAKAkKkp3vSYBcA4bJQ7fJ1N9lXrABB0=" media="screen" crossorigin="anonymous">





<meta property="og:title" content="【JS异步非全解04】事件循环机制与浏览器EventLoop" />
<meta property="og:description" content="事件循环机制EventLoop Event Loop 即事件循环，是浏览器或Node解决单线程运行不阻塞的一种机制 大纲链接§ [toc] 进程和线程 浏览器打开一个页面就相当" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://xmasuhai.xyz/post/promise/js%E5%BC%82%E6%AD%A5%E9%9D%9E%E5%85%A8%E8%A7%A304%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF%E6%9C%BA%E5%88%B6%E4%B8%8E%E6%B5%8F%E8%A7%88%E5%99%A8eventloop/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-12-31T23:11:17+08:00" />
<meta property="article:modified_time" content="2021-12-31T23:15:43+08:00" />

<meta itemprop="name" content="【JS异步非全解04】事件循环机制与浏览器EventLoop">
<meta itemprop="description" content="事件循环机制EventLoop Event Loop 即事件循环，是浏览器或Node解决单线程运行不阻塞的一种机制 大纲链接§ [toc] 进程和线程 浏览器打开一个页面就相当"><meta itemprop="datePublished" content="2021-12-31T23:11:17+08:00" />
<meta itemprop="dateModified" content="2021-12-31T23:15:43+08:00" />
<meta itemprop="wordCount" content="8703">
<meta itemprop="keywords" content="FrontEnd," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="【JS异步非全解04】事件循环机制与浏览器EventLoop"/>
<meta name="twitter:description" content="事件循环机制EventLoop Event Loop 即事件循环，是浏览器或Node解决单线程运行不阻塞的一种机制 大纲链接§ [toc] 进程和线程 浏览器打开一个页面就相当"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->




</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Joel in The House</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/">主页</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/post/">文档</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/tags/">标签</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/categories/">目录</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/about/">关于我</a>
          
        
      </li><li class="mobile-menu-item">
        
          
          <div class="mobile-menu-parent">
            <span class="mobile-submenu-open"></span>
            <a href="http://xmasuhai.xyz/">
              docs
            </a>
          </div>
          <ul class="mobile-submenu-list">
            
              <li>
                <a href="http://xmasuhai.xyz/post/test/syntax-highlighting/">Syntax Highlighting</a>
              </li>
            
              <li>
                <a href="http://xmasuhai.xyz/post/test/mytest/">my Syntax Highlighting &amp; ShortCode Test</a>
              </li>
            
          </ul>
        
      </li>
    

    
  </ul>
</nav>


  
    






  <link rel="stylesheet" href="/lib/photoswipe/photoswipe.min.css" />
  <link rel="stylesheet" href="/lib/photoswipe/default-skin/default-skin.min.css" />




<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

  

  

  

  <header id="header" class="header container">
    <div class="logo-wrapper">
  <a href="/" class="logo">
    
      Joel in The House
    
  </a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/">主页</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/post/">文档</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/tags/">标签</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/categories/">目录</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          
            <a class="menu-item-link" href="http://xmasuhai.xyz/about/">关于我</a>
          

        

      </li>
    
        <li class="menu-item">
        
          
          <a class="menu-item-link menu-parent" href="http://xmasuhai.xyz/">docs</a>
          <ul class="submenu">
            
              <li>
                <a href="http://xmasuhai.xyz/post/test/syntax-highlighting/">Syntax Highlighting</a>
              </li>
            
              <li>
                <a href="http://xmasuhai.xyz/post/test/mytest/">my Syntax Highlighting &amp; ShortCode Test</a>
              </li>
            
          </ul>

        

      </li>
    

    
    

    
  </ul>
</nav>

  </header>

  <div id="mobile-panel">
    <main id="main" class="main bg-llight">
      <div class="content-wrapper">
        <div id="content" class="content container">
          <article class="post bg-white">
    
    <header class="post-header">
      <h1 class="post-title">【JS异步非全解04】事件循环机制与浏览器EventLoop</h1>
      
      <div class="post-meta">
        <time datetime="2021-12-31" class="post-time">
          2021-12-31
        </time>
        <div class="post-category">
            <a href="http://xmasuhai.xyz/categories/frontend/"> FrontEnd </a>
            
          </div>
        <span class="more-meta"> 约 8703 字 </span>
          <span class="more-meta"> 预计阅读 18 分钟 </span>

        
        

        
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#大纲链接a-idcatalogue-hrefcatalogue---a">大纲链接<!-- raw HTML omitted --> § <!-- raw HTML omitted --></a></li>
    <li><a href="#进程和线程">进程和线程</a>
      <ul>
        <li><a href="#浏览器中的多线程">浏览器中的多线程</a></li>
      </ul>
    </li>
    <li><a href="#js事件循环机制">JS事件循环机制</a>
      <ul>
        <li><a href="#同步任务和异步任务执行顺序">同步任务和异步任务执行顺序</a></li>
        <li><a href="#同步任务和异步任务的执行过程">同步任务和异步任务的执行过程</a></li>
      </ul>
    </li>
    <li><a href="#宏任务与微任务的概念">宏任务与微任务的概念</a>
      <ul>
        <li><a href="#总结-event-loop-执行过程">总结 Event Loop 执行过程</a></li>
      </ul>
    </li>
    <li><a href="#举例分析宏任务和微任务的执行过程">举例分析宏任务和微任务的执行过程</a></li>
    <li><a href="#总结eventloop的概念及经典面试题">总结<code>EventLoop</code>的概念及经典面试题</a>
      <ul>
        <li><a href="#结合-eventloop-分析输出的顺序">结合 EventLoop 分析输出的顺序</a></li>
      </ul>
    </li>
    <li><a href="#异步经典面试题">异步经典面试题</a>
      <ul>
        <li><a href="#第一题">第一题：</a></li>
        <li><a href="#第二题">第二题：</a></li>
        <li><a href="#第三题">第三题：</a></li>
        <li><a href="#第四题">第四题：</a></li>
        <li><a href="#第五题">第五题：</a></li>
        <li><a href="#参考文章">参考文章</a></li>
        <li><a href="#相关文章">相关文章</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>

    
    <div class="post-content">
      <h1 id="事件循环机制eventloop">事件循环机制EventLoop</h1>
<blockquote>
<p>Event Loop 即事件循环，是浏览器或Node解决<strong>单线程运行不阻塞</strong>的一种机制</p>
</blockquote>
<h2 id="大纲链接a-idcatalogue-hrefcatalogue---a">大纲链接<!-- raw HTML omitted --> § <!-- raw HTML omitted --></h2>
<p>[toc]</p>
<hr>
<h2 id="进程和线程">进程和线程</h2>
<ul>
<li>浏览器打开一个页面就相当于开一个进程</li>
<li>在进程中可以同时做很多事情，每一个事情都有一个“线程”去处理</li>
<li>所以一个进程中可包含多个线程</li>
</ul>
<h3 id="浏览器中的多线程">浏览器中的多线程</h3>
<blockquote>
<p>浏览器中一般包含以下线程：</p>
</blockquote>
<ul>
<li>GUI 渲染线程：渲染页面 &amp; 绘制图形
<ul>
<li>绘制页面，解析HTML、CSS，构建DOM树等</li>
<li>页面的重绘和重排</li>
<li>与JS引擎互斥(JS引擎阻塞页面刷新)</li>
</ul>
</li>
<li>JS引擎线程：渲染和解析JS代码
<ul>
<li>js脚本代码执行</li>
<li>负责执行准备好的事件（任务队列中），例如定时器计时结束或异步请求成功且正确返回的回调</li>
<li>与GUI渲染线程互斥</li>
</ul>
</li>
<li>事件触发线程：监听事件触发
<ul>
<li>当对应的事件满足触发条件，将事件添加到js的任务队列末尾</li>
<li>多个事件加入任务队列需要排队等待</li>
</ul>
</li>
<li>定时触发器线程：给定时器计时
<ul>
<li>负责执行异步的定时器类事件：setTimeout、setInterval等</li>
<li>浏览器定时计时由该线程完成，计时完毕后将事件添加至任务队列队尾，等待主线程执行</li>
</ul>
</li>
<li>异步HTTP请求线程：基于HTTP网络从服务器端获取资源和信息
<ul>
<li>负责异步请求</li>
<li>当监听到异步请求状态变更时，如果存在回调函数，该线程会将回调函数加入到任务队列队尾</li>
</ul>
</li>
<li>WebWorker等</li>
</ul>
<h2 id="js事件循环机制">JS事件循环机制</h2>
<blockquote>
<p>浏览器是多线程的，异步任务借助浏览器的线程和JavaScript的执行机制实现</p>
</blockquote>
<ul>
<li>JS是单线程语言，浏览器只分配一个线程“JS引擎线程”用来解析运行JS代码，同一时间只能做一件事情</li>
<li>单线程执行任务队列：如果前一个任务非常耗时，则后续任务必须一致等待，从而导致程序假死</li>
</ul>
<h3 id="同步任务和异步任务执行顺序">同步任务和异步任务执行顺序</h3>
<h4 id="同步与异步">同步与异步</h4>
<blockquote>
<p>计算机领域中的同步与异步和中文翻译的同步和异步正好相反</p>
<p>计算机中的同步是连续性的动作，上一步未完成前，下一步会发生堵塞，直至上一步完成后，下一步才可以继续执行</p>
</blockquote>
<ul>
<li>为防止某个耗时任务导致程序假死，JS将执行的任务分为两类</li>
</ul>
<ol>
<li>同步任务 <code>synchronous</code></li>
</ol>
<ul>
<li>又称为<strong>非耗时任务</strong>，指的是<strong>在主线程上排队执行的任务</strong></li>
<li>只有前一个任务执行完毕，才能执行后一个任务，即按代码顺序执行</li>
</ul>
<ol start="2">
<li>异步任务 <code>asynchronous</code></li>
</ol>
<ul>
<li>又称为<strong>耗时任务</strong>，异步任务由JS委托给 <strong>宿主环境(浏览器/Node.js)</strong> 进行执行</li>
<li>异步任务首先到 Event Table 进行回调函数注册</li>
<li>当异步任务的触发条件满足，将回调函数从Event Table 压入 Event Queue 中</li>
</ul>
<h3 id="同步任务和异步任务的执行过程">同步任务和异步任务的执行过程</h3>
<p><img src="https://note.youdao.com/yws/api/personal/file/7D81B05F59394FDD891F6E8DC3FF95CB?method=download&amp;shareKey=decef8572d95a3a90b105afc7ac1a10e" alt="EventLoop"></p>
<ul>
<li>同步任务由JS主线程依次执行</li>
<li>异步任务委托给宿主环境执行</li>
<li>已完成的异步任务<strong>对应的回调函数</strong>，会被加入到<strong>任务队列</strong>中等待执行</li>
<li>JS主线程的<strong>执行栈</strong>清空后（当前的同步任务执行完成），会依次读取任务队列中的回调函数，放到执行栈中执行（即通知JS主线程执行 Event Queue 中<strong>回调函数</strong>）</li>
<li>只要主线程空了，就会去 Event Queue 读取回调函数</li>
<li>JS主线程不断重复以上步骤，这个过程被称为 Event Loop</li>
</ul>
<blockquote>
<p>举例</p>
</blockquote>
<ul>
<li><code>setTimeout(cb, 1000)</code>，当1000ms后，就将cb压入 Event Queue</li>
<li><code>ajax(请求条件, cb)</code>，当http请求发送成功后，cb压入 Event Queue</li>
</ul>
<blockquote>
<p>补充</p>
</blockquote>
<ul>
<li>队列：先进先出 （队列弹药夹）</li>
<li>栈：后进先出（薯片栈）</li>
</ul>
<hr>
<blockquote>
<p>JavaScript的异步任务是存在优先级的</p>
</blockquote>
<h2 id="宏任务与微任务的概念">宏任务与微任务的概念</h2>
<blockquote>
<p>除了广义上将任务划分为同步任务和异步任务（耗时任务），异步任务又进一步分为宏任务和微任务：</p>
</blockquote>
<ul>
<li>异步宏任务 <code>macrotask</code>
<ul>
<li><strong>异步的数据请求: <code>Ajax/Fetch</code></strong></li>
<li>定时器 API<code>setTimeout/setInterval</code></li>
<li>动画回调<code>requestAnimationFrame</code> “图穷匕见”</li>
<li>文件操作，即 <code>I/O</code> 操作</li>
<li>事件绑定/队列</li>
<li>MessageChannel</li>
<li>setImmediate[NODE]</li>
<li>history traversal任务（h5当中的历史操作）</li>
<li>其他</li>
</ul>
</li>
<li>异步微任务 <code>microtask</code>
<ul>
<li><code>Promise.then()</code>、<code>.catch()</code>和<code>.finally()</code>；<code>Promise.all()</code>、<code>Promise.any()</code>、<code>Promise.allSettled()</code>、<code>Promise.race()</code>等</li>
<li><strong><code>async/await</code></strong></li>
<li><code>queueMicrotask</code></li>
<li><code>MutationObserver</code>（h5新增，用来监听DOM节点变化的）</li>
<li><code>IntersectionObserver</code></li>
<li><strong><code>requestAnimationFrame</code></strong></li>
<li><code>process.nextTick</code>(Node.js)</li>
<li>其他</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>实例化 new Promise(Cb) 实例中的回调函数Cb为同步任务</strong></p>
</blockquote>
<hr>
<h3 id="总结-event-loop-执行过程">总结 Event Loop 执行过程</h3>
<p><img src="https://note.youdao.com/yws/api/personal/file/AD8B5BF7483D430085A489ECF5DE0B79?method=download&amp;shareKey=35a302a5b0bcc985868f53aec8db447d" alt="Event Loop的执行顺序图"></p>
<blockquote>
<p>注意事项</p>
</blockquote>
<ul>
<li>每一个宏任务执行完之后，都会检查<strong>是否存在待执行的微任务</strong>，如果有，则执行完所有微任务之后，再继续执行下一个宏任务</li>
<li>宏任务和微任务是<strong>交替执行的</strong></li>
<li>宏任务和微任务分别有各自的任务队列 Event Queue，即宏任务队列和微任务队列</li>
</ul>
<blockquote>
<p>执行过程</p>
</blockquote>
<ol>
<li>代码开始执行，创建一个全局调用栈，script 作为宏任务执行</li>
<li>执行过程过同步任务立即执行，异步任务根据异步任务类型分别注册到<strong>微任务队列</strong>和<strong>宏任务队列</strong></li>
<li>同步任务执行完毕，查看微任务队列</li>
<li>若存在微任务，将微任务队列全部执行(包括<strong>执行微任务过程中产生的新微任务</strong>)</li>
<li>若无微任务，查看宏任务队列，执行第一个宏任务，宏任务执行完毕，查看微任务队列，重复上述操作，直至宏任务队列为空</li>
</ol>
<hr>
<h2 id="举例分析宏任务和微任务的执行过程">举例分析宏任务和微任务的执行过程</h2>
<blockquote>
<p>示例</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// Promise.resolve 返回一个带着给定值 解析过的 Promise 对象
</span><span class="c1">// 如果参数本身就是一个 Promise 对象，则直接返回这个 Promise 对象
</span><span class="c1"></span><span class="kd">let</span> <span class="nx">p1</span> <span class="o">=</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;p1&#39;</span><span class="p">,</span> <span class="nx">p1</span><span class="p">)</span> <span class="c1">// p1 Promise {&lt;fulfilled&gt;: 100}
</span><span class="c1"></span>
<span class="kd">let</span> <span class="nx">p2</span> <span class="o">=</span> <span class="nx">p1</span>
  <span class="c1">// p1.then 时，此处的 onfulfilled 方法放在 Event Queue 中的微任务队列等待执行（@A）
</span><span class="c1"></span>  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`成功: </span><span class="si">${</span><span class="nx">result</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;p2 1st&#39;</span><span class="p">,</span> <span class="nx">p2</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">result</span> <span class="o">*</span> <span class="mi">10</span>
  <span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;p2 2nd&#39;</span><span class="p">,</span> <span class="nx">p2</span><span class="p">)</span> <span class="c1">// p2 2nd Promise {&lt;pending&gt;}
</span><span class="c1"></span>
<span class="nx">p2</span>
  <span class="c1">// 此时还不知道 p2 的状态，把 onfulfilled 放在 Event Queue 中的微任务队列等待执行（@B）
</span><span class="c1"></span>  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">result</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`成功: </span><span class="si">${</span><span class="nx">result</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;p2 3rd&#39;</span><span class="p">,</span> <span class="nx">p2</span><span class="p">)</span>
  <span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;SYNC END&#39;</span><span class="p">)</span>

<span class="c1">// 同步代码结束后，开始执行@A -&gt; 成功：100 -&gt;
</span><span class="c1">// 并且修改 p2 的状态为 成功，值是1000； -&gt;
</span><span class="c1">// 此时 @B 可以执行了 -&gt;
</span><span class="c1">// 把 @B 也放在等待的异步微任务队列中 -&gt;
</span><span class="c1">// 如果没有其他的异步任务执行，这把@B也拿出来执行 -&gt;
</span><span class="c1">// 成功：1000
</span><span class="c1"></span>
<span class="cm">/*
</span><span class="cm">p1 Promise { 100 }
</span><span class="cm">p2 2nd Promise { &lt;pending&gt; }
</span><span class="cm">SYNC END
</span><span class="cm">成功: 100
</span><span class="cm">p2 1st Promise { &lt;pending&gt; }
</span><span class="cm">成功: 1000
</span><span class="cm">p2 3rd Promise { 1000 }
</span><span class="cm">* */</span>

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>基于then返回的 promise 实例的状态和值，主要看 onFulfilled/onrRejected 是否执行</p>
</blockquote>
<ul>
<li>函数返回的不是 promise 实例：
<ul>
<li>方法执行不报错，p2 状态是 成功，值即返回值</li>
<li>方法执行报错，则 p2 是失败的，值是报错原因</li>
</ul>
</li>
<li>函数返回的是 promise 实例：则这个实例的状态和值决定了 p2 的状态和值</li>
</ul>
<hr>
<blockquote>
<p>示例：</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">let</span> <span class="nx">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;p1&#39;</span><span class="p">,</span> <span class="nx">p1</span><span class="p">)</span>  <span class="c1">// p1 -&gt; Promise {&lt;fulfilled&gt;: 100}
</span><span class="c1"></span><span class="cm">/*
</span><span class="cm">1
</span><span class="cm">2
</span><span class="cm">p1 -&gt; Promise {&lt;fulfilled&gt;: 100}
</span><span class="cm">*/</span>

<span class="kd">let</span> <span class="nx">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="c1">// 会先将 p2 的状态变为 fulfilled
</span><span class="c1"></span>  <span class="nx">reject</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="c1">// 之后 p2 的状态不再变化
</span><span class="c1"></span>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;p2&#39;</span><span class="p">,</span> <span class="nx">p2</span><span class="p">)</span>
<span class="kd">let</span> <span class="nx">p3</span> <span class="o">=</span> <span class="nx">p2</span><span class="p">.</span><span class="nx">then</span><span class="p">(()=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;p2&#39;</span><span class="p">,</span> <span class="nx">p2</span><span class="p">))</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;p2&#39;</span><span class="p">,</span> <span class="nx">p2</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;p3&#39;</span><span class="p">,</span> <span class="nx">p3</span><span class="p">)</span>
<span class="cm">/*
</span><span class="cm">1
</span><span class="cm">2
</span><span class="cm">p2 Promise {&lt;fulfilled&gt;: 100}
</span><span class="cm">p2 Promise {&lt;fulfilled&gt;: 100}
</span><span class="cm">p3 Promise {&lt;pending&gt;}
</span><span class="cm">p2 Promise {&lt;fulfilled&gt;: 100}
</span><span class="cm">*/</span>

<span class="kd">let</span> <span class="nx">p4</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="nx">reject</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="c1">// 会先将 p2 的状态变为 rejected
</span><span class="c1"></span>  <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="c1">// 之后 p2 的状态不再变化
</span><span class="c1"></span>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;p4&#39;</span><span class="p">,</span> <span class="nx">p4</span><span class="p">)</span>
<span class="c1">// 1
</span><span class="c1">// 2
</span><span class="c1">// p4 Promise {&lt;rejected&gt;: 100}
</span><span class="c1"></span>
<span class="kd">let</span> <span class="nx">p5</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="nx">reject</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="c1">// 会先将 p2 的状态变为 rejected
</span><span class="c1"></span>  <span class="nx">resolve</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="c1">// 之后 p2 的状态不再变化
</span><span class="c1"></span>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="p">}).</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;p5&#39;</span><span class="p">,</span> <span class="nx">p5</span><span class="p">)})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;p5&#39;</span><span class="p">,</span> <span class="nx">p5</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>new Promise(Cb)</code> 实参 回调函数：Cb是同步代码，立即执行</li>
<li>回调函数：Cb的形参 <code>resolve</code> <code>reject</code>
<ul>
<li>一旦执行<code>resolve()</code>或<code>reject()</code>就会将状态变为对应的<code>resolved</code>或<code>rejected</code>，不再改变</li>
<li>一般会使用分支语句或者<code>try..catch..</code>分别调用<code>resolve()</code>、<code>reject()</code></li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>调用<code>resolve()</code>的时机</strong>，示例：</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">let</span> <span class="nx">p2</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span> <span class="cm">/*， reject*/</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="c1">// resolve(200) // 同步调用
</span><span class="c1"></span>
  <span class="c1">// setTimeoutA
</span><span class="c1"></span>  <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="cm">/*
</span><span class="cm">    // resolve(p2)
</span><span class="cm">    // 失败:TypeError: Chaining cycle detected for promise #&lt;Promise&gt;
</span><span class="cm">    */</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;p2 inside1&#39;</span><span class="p">,</span> <span class="nx">p2</span><span class="p">)</span>
    <span class="c1">// 在宏任务setTimeout中调用成功回调 resolve()
</span><span class="c1"></span>    <span class="nx">resolve</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="c1">// 调用成功回调 resolve() 更新实例的状态和值
</span><span class="c1"></span>    <span class="c1">// 之后的所有 .then 方法都为宏任务中的微任务，在当前宏任务执行完毕后执行
</span><span class="c1"></span>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;p2 inside2&#39;</span><span class="p">,</span> <span class="nx">p2</span><span class="p">)</span> <span class="c1">// p2 inside Promise {&lt;fulfilled&gt;: 200}
</span><span class="c1"></span>  <span class="p">},</span> <span class="mi">1000</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1">// 此时还不知道 p2 实例的状态
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;p2 outside1&#39;</span><span class="p">,</span> <span class="nx">p2</span><span class="p">)</span> <span class="c1">// p2 outside Promise {&lt;pending&gt;}
</span><span class="c1"></span>
<span class="c1">// 异步微任务 thenA
</span><span class="c1"></span><span class="nx">p2</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span>
  <span class="nx">result</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`成功结果为:</span><span class="si">${</span><span class="nx">result</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">result</span>
  <span class="p">},</span>
  <span class="nx">reason</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`失败原因为:</span><span class="si">${</span><span class="nx">reason</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">reason</span>
  <span class="p">}</span>
<span class="p">)</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;res&#39;</span><span class="p">,</span> <span class="nx">res</span><span class="p">)})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;p2 outside2&#39;</span><span class="p">,</span> <span class="nx">p2</span><span class="p">)</span>

<span class="cm">/*
</span><span class="cm">p2 outside1 Promise { &lt;pending&gt; }
</span><span class="cm">p2 outside2 Promise { &lt;pending&gt; }
</span><span class="cm">p2 inside1 Promise { &lt;pending&gt; }
</span><span class="cm">p2 inside2 Promise {&lt;fulfilled&gt;: 200}
</span><span class="cm">成功结果为:200
</span><span class="cm">res 200
</span><span class="cm">*/</span>

</code></pre></td></tr></table>
</div>
</div><ul>
<li>在同步代码中调用 <code>resolve()</code>，之后的 .then 方法都为微任务，按顺序添加到微任务队列中</li>
<li>在宏任务中调用 <code>resolve()</code>，之后的 .then 方法都为宏任务中的微任务，需在<strong>当前宏任务执行之后</strong>，按顺序添加到微任务队列中</li>
</ul>
<blockquote>
<p>示例：</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// macrotask
</span><span class="c1"></span><span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">)})</span>
<span class="c1">// synchronous
</span><span class="c1"></span><span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
  <span class="nx">resolve</span><span class="p">()</span>
<span class="p">})</span>
  <span class="c1">// microtask
</span><span class="c1"></span>  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)})</span>
<span class="c1">// synchronous
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>

</code></pre></td></tr></table>
</div>
</div><ul>
<li>将<code>setTimeout</code>放到宏任务队列</li>
<li>执行同步任务<code>new Promise(function (resolve) {})</code></li>
<li>将<code>.then()</code>放到微任务队列</li>
<li>执行同步任务<code>console.log('2')</code></li>
<li>执行微任务队列中所有微任务<code>.then()</code></li>
<li>执行下一个宏任务<code>setTimeout</code></li>
</ul>
<blockquote>
<p>总结影响异步代码执行顺序的因素</p>
</blockquote>
<ol>
<li>同步代码的耗时</li>
<li>异步微任务队列</li>
<li>异步宏任务队列</li>
<li>I/O 宏任务之后的微任务 .then()</li>
<li>setTimeout 的耗时影响<strong>回调被添加到任务队列的时机</strong></li>
<li>在 setTimeout 回调函数中调用 resolve()，影响依赖此实例的微任务 .then()</li>
</ol>
<blockquote>
<p>加强示例</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">sleep</span> <span class="o">=</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">resolve</span><span class="p">(</span><span class="mi">300</span><span class="p">)</span>
      <span class="p">},</span>
      <span class="mi">1000</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">};</span>

<span class="p">;(</span><span class="kr">async</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="c1">// await 后面放置的不是一个 Promise 实例
</span><span class="c1"></span>  <span class="c1">// 则浏览器默认会把其转换为一个“状态为成功
</span><span class="c1"></span>  <span class="c1">// 值就是 await 后的值”的 promise 实例
</span><span class="c1"></span>  <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="kr">await</span> <span class="mi">1</span> <span class="c1">// await Promise.resolve(1)
</span><span class="c1"></span>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;result 1st&#39;</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>

  <span class="nx">result</span> <span class="o">=</span> <span class="kr">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;result 2nd&#39;</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>

  <span class="nx">result</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">sleep</span><span class="p">()</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;result 3rd&#39;</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span>
  <span class="c1">// 先 sleep 执行
</span><span class="c1"></span>  <span class="c1">// 把返回的 promise 实例放在 await 后面等着
</span><span class="c1"></span>  <span class="c1">// 当前案例只有 1000ms 后，才能知道实例状态
</span><span class="c1"></span><span class="p">})()</span>

<span class="cm">/*
</span><span class="cm">result 1st 1
</span><span class="cm">result 2nd 2
</span><span class="cm">result 3rd 300
</span><span class="cm">* */</span>

</code></pre></td></tr></table>
</div>
</div><ul>
<li>await 需要等待<strong>后面的 promise 实例是状态为成功</strong>时，才会执行之后的代码</li>
<li>首先 当前上下文中，await 之后的代码都是<strong>异步微任务</strong> @aw</li>
<li>如果已经知道 await 后面的实例状态是成功的话
<ul>
<li>则 @aw 直接放在Event Queue中，等待执行即可</li>
</ul>
</li>
<li>如果 await 后面实例状态是失败的话
<ul>
<li>则 @aw 在 Web API 中永远不会进入到 Event Queue中，因为永远不会执行</li>
</ul>
</li>
<li>如果暂时还不知道是成功还是失败，则 @aw 先放置在 Web API 中
<ul>
<li>等到知道实例状态是成功后，再挪至到 Event Queue 中等待执行</li>
</ul>
</li>
</ul>
<hr>
<h2 id="总结eventloop的概念及经典面试题">总结<code>EventLoop</code>的概念及经典面试题</h2>
<blockquote>
<p>JS主线程中任务队列中读取异步任务的回调函数，放到执行栈中依次执行，这个过程是循环不断的，整个机制又称为 EventLoop 事件循环</p>
</blockquote>
<h3 id="结合-eventloop-分析输出的顺序">结合 EventLoop 分析输出的顺序</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">import</span> <span class="nx">thenFs</span> <span class="nx">from</span> <span class="s1">&#39;then-fs&#39;</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
<span class="nx">thenFs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;./files/1.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">dataStr</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="p">})</span>
<span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">0</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">)</span>

<span class="c1">// ADCB
</span><span class="c1">// sycn AD
</span><span class="c1">// setTimeout 0 C
</span><span class="c1">// readFile cost time then B
</span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>分析</p>
</blockquote>
<ul>
<li>A D 属于同步任务，根据代码的先后顺序依次被执行</li>
<li><code>thenFs.readFile</code>异步任务，具体为** <code>I/O</code>任务**，属于宏任务，委托给宿主环境执行</li>
<li><code>setTimeout</code> 异步任务，委托给宿主环境执行</li>
<li><code>thenFs.readFile</code>消耗耗一定的时间后将回调函数放入任务队列，<code>setTimeout</code> 延迟 0，立即将回调放入任务队列</li>
<li>读文件的过程不可能是0秒，最快也是几毫秒，这样就慢于<code>setTimeout</code>执行完毕</li>
<li><code>I/O</code>任务和setTimeout同样是宏任务，按先来顺序执行，但 B 是在 I/O 宏任务之后的 promise 微任务里面打印的，所以应该先打印C</li>
<li>任务队列先进先出，首先执行的是<code>setTimeout</code>的回调函数，后执行的是<code>thenFs.readFile</code>的回调函数</li>
</ul>
<blockquote>
<p>小结</p>
</blockquote>
<ul>
<li>I/O 任务和 setTimeout 同样是宏任务，按先后顺序执行</li>
<li>I/O 宏任务里面的 微任务 .then() 需要等待当前宏任务执行完毕，在依次添加到微任务队列中等待执行</li>
<li><strong>异步任务操作的耗时</strong>影响着其回调函数被<strong>加入到任务队列的先后顺序</strong>
<ul>
<li><code>setTimeout</code>耗时由第二个参数决定</li>
<li><code>thenFs.readFile</code>耗时不定，取决于文件</li>
</ul>
</li>
</ul>
<blockquote>
<p>关于 setTimeout 耗时</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">},</span> <span class="mi">20</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="p">},</span> <span class="mi">10</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">90000000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{}</span> <span class="c1">// 同步代码耗时 耗时100ms左右
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
<span class="p">},</span> <span class="mi">8</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
<span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
<span class="p">},</span> <span class="mi">15</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>

<span class="cm">/*
</span><span class="cm">- 同步执行
</span><span class="cm"> - console.log(2);
</span><span class="cm"> - console.log(4);
</span><span class="cm"> - console.log(5);
</span><span class="cm"> - console.log(7);
</span><span class="cm"> - console.log(9);
</span><span class="cm">- Web API 定时器线程
</span><span class="cm"> - console.log(1); 20ms
</span><span class="cm"> - console.log(3); 10ms
</span><span class="cm"> - console.log(6); 8ms + 同步代码耗时
</span><span class="cm"> - console.log(8); 15ms + 同步代码耗时
</span><span class="cm">- 异步队列
</span><span class="cm">  - 异步微任务队列
</span><span class="cm">   - 无
</span><span class="cm">  - 异步宏任务队列
</span><span class="cm">   - console.log(3);
</span><span class="cm">   - console.log(1);
</span><span class="cm">   - console.log(6);
</span><span class="cm">   - console.log(8);
</span><span class="cm">- Event Queue
</span><span class="cm"> - console.log(3);
</span><span class="cm"> - console.log(1);
</span><span class="cm"> - console.log(6);
</span><span class="cm"> - console.log(8);
</span><span class="cm">*/</span> 
</code></pre></td></tr></table>
</div>
</div><ul>
<li>Web API任务事件监听队列，定时器任务，浏览器开始分配一个定时器监听线程，计时完毕，将回调函数放到宏任务队列中</li>
<li>多个定时器，第二个参数决定<strong>将回调函数添加到宏任务队列中</strong>的先后顺序</li>
<li>定时器第二个参数相同时，则按代码顺序添加</li>
<li>一般情况，同步代码的耗时不考虑在内；如果定时器第二个参数为毫秒级别，耗时相近的定时器任务不能确定哪一个先添加到红任务队列中</li>
</ul>
<hr>
<h2 id="异步经典面试题">异步经典面试题</h2>
<h3 id="第一题">第一题：</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// declaration
</span><span class="c1"></span><span class="kr">async</span> <span class="kd">function</span> <span class="nx">async1</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async1 start&#39;</span><span class="p">)</span>
  <span class="kr">await</span> <span class="nx">async2</span><span class="p">()</span> <span class="c1">// 从 async2 返回的 Promise 对象 被忽略
</span><span class="c1"></span>  <span class="c1">// microtask A
</span><span class="c1"></span>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async1 end&#39;</span><span class="p">)</span>
<span class="p">}</span>
<span class="kr">async</span> <span class="kd">function</span> <span class="nx">async2</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async2&#39;</span><span class="p">)</span> <span class="c1">// return undefined
</span><span class="c1"></span><span class="p">}</span>
<span class="c1">// run code
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;script start&#39;</span><span class="p">)</span>
<span class="c1">// setTimeout A 加入宏任务队列
</span><span class="c1"></span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;setTimeout&#39;</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">0</span><span class="p">)</span>
<span class="c1">// sync A
</span><span class="c1"></span><span class="nx">async1</span><span class="p">()</span> <span class="c1">// 从 async1 返回的 Promise 被忽略
</span><span class="c1">// sync B
</span><span class="c1"></span><span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;promise1&#39;</span><span class="p">)</span>
  <span class="nx">resolve</span><span class="p">()</span>
<span class="p">})</span>
<span class="c1">// then A
</span><span class="c1"></span>  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;promise2&#39;</span><span class="p">)</span>
  <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;script end&#39;</span><span class="p">)</span>

<span class="cm">/*
</span><span class="cm">- 执行栈
</span><span class="cm">  - console.log(&#39;script start&#39;); // sync code
</span><span class="cm">  - console.log(&#39;async1 start&#39;); // sync code in async1
</span><span class="cm">  - console.log(&#39;async2&#39;); // sync code in async2
</span><span class="cm">  - console.log(&#39;promise1&#39;); // sync code
</span><span class="cm">  - console.log(&#39;script end&#39;); // sync code
</span><span class="cm">  - console.log(&#39;async1 end&#39;); // microtask A in async1
</span><span class="cm">  - console.log(&#39;promise2&#39;); // then A
</span><span class="cm">  - console.log(&#39;setTimeout&#39;); // sync code in setTimeout A
</span><span class="cm">
</span><span class="cm">- 微任务队列
</span><span class="cm">  -[x] microtask A in async1
</span><span class="cm">  -[x] then A
</span><span class="cm">
</span><span class="cm">- 宏任务队列
</span><span class="cm">  -[x] setTimeout A
</span><span class="cm">
</span><span class="cm">* */</span>

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>分析 执行<code>await async2()</code></p>
</blockquote>
<ul>
<li>先得到 <code>await</code> 右侧表达式的结果
<ul>
<li>即执行 <code>async2()</code>，打印同步代码 <code>console.log('async2')</code></li>
<li>并且 <code>return Promise.resolve(undefined)</code></li>
</ul>
</li>
<li><code>await</code> 表达式执行后，将后续代码作为微任务推入微任务队列（可以标记为 microtask A）</li>
<li>再中断 <code>async</code> 函数，先执行 <code>async1()</code> 外的同步代码（包括如果后面有 .then也中断执行）</li>
</ul>
<blockquote>
<p>分析 执行 <code>new Promise()</code></p>
</blockquote>
<ul>
<li>Promise 构造函数是直接调用的同步代码，所以 <code>console.log( 'promise1' )</code></li>
</ul>
<blockquote>
<p>代码运行到 <code>promise.then()</code></p>
</blockquote>
<ul>
<li>是微任务，所以暂时不打印</li>
<li>只是推入当前宏任务的微任务队列中</li>
<li>微任务会在当前宏任务的同步代码执行完毕，才会依次执行</li>
</ul>
<blockquote>
<p>同步代码执行完毕，开始执行微任务队列</p>
</blockquote>
<ul>
<li>回到 <code>async</code> 内部，执行 <code>await Promise.resolve(undefined)</code></li>
<li>如果一个 <code>Promise</code> 对象被传递给一个 await 操作符，await 将等待 Promise 正常处理完成并返回其处理结果，即从 <code>Promise</code> 对象中 <strong>解包出 返回值</strong></li>
<li>本例中就是 <code>Promise.resolve(undefined)</code> 正常处理完成，并返回其处理结果 <code>undefined</code></li>
</ul>
<hr>
<blockquote>
<p>小结1</p>
</blockquote>
<ul>
<li>将语句的执行类型分为 <strong>同步</strong> 和 <strong>异步</strong>
<ul>
<li>异步又分为 <strong>宏任务</strong> 和 <strong>微任务</strong></li>
</ul>
</li>
<li><code>async function xxx() {}</code> 异步函数中，关键字<code>await</code>第一次出现之前的语句，为<strong>同步执行</strong>，包括 <strong>首个<code>await</code></strong> 修饰的语句也是<strong>同步执行</strong>（ await 操作符是从右往左执行）</li>
<li><strong>首个<code>await</code></strong> 语句的后续代码为异步执行
<ul>
<li>可看做是微任务，依次添加到微任务队列</li>
</ul>
</li>
<li>如果一个 <code>Promise</code> 对象被传递给一个 await 操作符，await 将等待 Promise 正常处理完成并返回其处理结果，即从 <code>Promise</code> 对象中 <strong>解包出 返回值</strong></li>
<li><code>await</code> 表达式的后续代码被阻塞后，要执行 <code>async</code> 之外的代码</li>
<li>await  操作符用于等待一个Promise 对象。只能在异步函数 async function 中使用
<ul>
<li><code>[返回值] = await 表达式;</code></li>
<li>表达式为一个 Promise 对象或者任何要等待的值</li>
<li>返回值为返回 Promise 对象的处理结果</li>
<li>如果等待的不是 Promise 对象，则返回该值本身</li>
</ul>
</li>
</ul>
<blockquote>
<p>小结2</p>
</blockquote>
<ul>
<li><code>new Promise(function (resolve) {})</code> Promise 实例化语句中的回调函数 <code>function (resolve) {}</code>是 <strong>同步执行</strong></li>
<li><code>new Promise(function (resolve) {})</code>中 如果不调用 <code>resolve()</code> ，就永不执行 后续 <code>.then</code> 的回调</li>
<li><code>.then()</code> 的回调函数为异步执行，添加到 <strong>微任务队列</strong></li>
<li>使用 <code>new Promise()</code>，调用 resolve 后，需要在 .then 的第一个参数里，才能拿到结果
<ul>
<li>即调用 <code>resolve</code> 时，会把 .then 的参数推入微任务队列，等主线程空闲时，再执行</li>
</ul>
</li>
</ul>
<blockquote>
<p>思考如果代码变为以下，该如何执行</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">async1</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async1 start&#39;</span><span class="p">)</span>
  <span class="kr">await</span> <span class="nx">async2</span><span class="p">()</span>
  <span class="c1">// microtask A
</span><span class="c1"></span>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async1 end&#39;</span><span class="p">)</span>
<span class="p">}</span>
<span class="kr">async</span> <span class="kd">function</span> <span class="nx">async2</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async2&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// run code
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;script start&#39;</span><span class="p">)</span>
<span class="c1">// setTimeout A
</span><span class="c1"></span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;setTimeout&#39;</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">0</span><span class="p">)</span>
<span class="c1">// sync A
</span><span class="c1"></span><span class="nx">async1</span><span class="p">()</span>
  <span class="c1">// then B
</span><span class="c1"></span>  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;res: &#39;</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span>
<span class="p">})</span>
<span class="c1">// sync B
</span><span class="c1"></span><span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;promise1&#39;</span><span class="p">)</span>
  <span class="c1">// 去掉 // resolve() 就永不执行 后续 then 的回调
</span><span class="c1"></span><span class="p">})</span>
  <span class="c1">// then A
</span><span class="c1"></span>  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;promise2&#39;</span><span class="p">)</span>
  <span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;script end&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>解异步执行顺序题的公式，准备以下几个框：</p>
</blockquote>
<ol>
<li>主线程执行栈</li>
<li>微任务队列</li>
<li>宏任务队列</li>
<li>Web API （定时器等）</li>
<li>Event Queue</li>
</ol>
<blockquote>
<p>按照代码顺序将相应类型的语句依次添加到 <strong>执行栈-&gt;微任务队列-&gt;宏任务队列</strong></p>
<p>依次执行 <strong>执行栈中的语句-&gt;微任务队列中的语句-&gt;宏任务队列中的语句</strong>
问题：</p>
</blockquote>
<ul>
<li>async 做一件什么事情</li>
<li>await 在等什么</li>
<li>await 等到之后，做了一件什么事情</li>
<li>async/await 比 promise有哪些优势</li>
</ul>
<h4 id="async-做一件什么事情">async 做一件什么事情</h4>
<blockquote>
<p>带 async 关键字的函数，使得函数的返回值必定是 promise 对象</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="p">(</span><span class="kr">async</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{})()</span> <span class="c1">// Promise {&lt;fulfilled&gt;: undefined}
</span><span class="c1"></span><span class="p">(</span><span class="kr">async</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span><span class="k">return</span> <span class="mi">1</span><span class="p">})()</span> <span class="c1">// Promise {&lt;fulfilled&gt;: 1}
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>仅是把return值包装成了promise对象
<ul>
<li>如果async关键字函数返回的不是promise，会自动用<code>Promise.resolve()</code>包装</li>
<li>如果async关键字函数显式地返回promise，那就以返回的promise为准</li>
</ul>
</li>
<li>在语义上，async表示函数内部有异步操作</li>
<li>await 关键字要在 async 关键字函数的内部，await 写在外面会报错</li>
</ul>
<hr>
<h4 id="await-在等什么">await 在等什么</h4>
<blockquote>
<p>await等的是 <strong>右侧「表达式」的结果</strong></p>
</blockquote>
<ul>
<li>右侧如果是函数，那么这个函数的return值就是「await表达式的结果」</li>
<li>右侧如果是一个 常量，那await表达式的结果就是 这个常量</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">async1</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s1">&#39;async1 start&#39;</span> <span class="p">)</span>
    <span class="kr">await</span> <span class="nx">async2</span><span class="p">()</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s1">&#39;async1 end&#39;</span> <span class="p">)</span>
<span class="p">}</span>

<span class="kr">async</span> <span class="kd">function</span> <span class="nx">async2</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s1">&#39;async2&#39;</span> <span class="p">)</span>
<span class="p">}</span>

<span class="nx">async1</span><span class="p">()</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s1">&#39;script start&#39;</span> <span class="p">)</span>

<span class="cm">/*
</span><span class="cm">async1 start
</span><span class="cm">async2
</span><span class="cm">script start
</span><span class="cm">async1 end
</span><span class="cm">*/</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li><code>await</code> 表达式 会让出线程，阻塞 <strong>await表达式后面</strong> 的代码</li>
<li><strong>从右向左</strong>，先执行async2后，发现有await关键字，于是让出线程，阻塞 <strong>await表达式代码</strong>后面的代码（如果有）</li>
<li>先打印async2 （同步），后打印的script start（同步）</li>
</ul>
<hr>
<h4 id="await-等到之后做了一件什么事情">await 等到之后，做了一件什么事情</h4>
<blockquote>
<p>等到之后，对于await来说，分2个情况</p>
</blockquote>
<ul>
<li>不是promise对象</li>
<li>是promise对象</li>
</ul>
<blockquote>
<p>分析</p>
</blockquote>
<ul>
<li>如果不是 promise , await会阻塞 <strong>await表达式</strong> 后面的代码，先执行async 函数外面的同步代码
<ul>
<li>同步代码执行完，再回到async内部，把这个非promise的东西，作为 await表达式的结果 （微任务）</li>
</ul>
</li>
<li>如果它等到的是一个 promise 对象，await 也会暂停async 函数后面的代码，先执行async函数外面的同步代码
<ul>
<li>等到 Promise 对象 fulfilled后</li>
<li>把 resolve 的参数作为 await 表达式的运算结果 （微任务）</li>
</ul>
</li>
</ul>
<blockquote>
<p>解析宏任务、微任务的执行过程</p>
</blockquote>
<ul>
<li>如果将整个script代码块执行的代码看做是一个 宏任务</li>
<li>则先执行 这个宏任务中的同步代码</li>
<li>如果执行中遇到 setTimeout 之类宏任务，就把这个 setTimeout 内部的函数推入「宏任务的队列」中，下一轮宏任务执行时调用</li>
<li>如果执行中遇到 promise.then() 之类的微任务，就推入到「当前宏任务的微任务队列」中，在本轮宏任务的同步代码执行都完成后，依次执行微任务队列中所有的微任务</li>
</ul>
<hr>
<h4 id="asyncawait-比-promise有哪些优势">async/await 比 promise有哪些优势</h4>
<hr>
<h3 id="第二题">第二题：</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// sync
</span><span class="c1"></span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
<span class="c1">// setTimeout A
</span><span class="c1"></span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
  <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
    <span class="nx">resolve</span><span class="p">()</span>
  <span class="p">})</span>
    <span class="c1">// then B
</span><span class="c1"></span>    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;4&#39;</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">},</span> <span class="mi">0</span><span class="p">)</span>
<span class="c1">// sync
</span><span class="c1"></span><span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;5&#39;</span><span class="p">)</span>
  <span class="nx">resolve</span><span class="p">()</span>
<span class="p">})</span>
  <span class="c1">// then A
</span><span class="c1"></span>  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;6&#39;</span><span class="p">)</span>
  <span class="p">})</span>
<span class="c1">// setTimeout B
</span><span class="c1"></span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;7&#39;</span><span class="p">)</span>
  <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;8&#39;</span><span class="p">)</span>
    <span class="nx">resolve</span><span class="p">()</span>
  <span class="p">})</span>
    <span class="c1">// then C
</span><span class="c1"></span>    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;9&#39;</span><span class="p">)</span>
    <span class="p">})</span>
<span class="p">},</span> <span class="mi">0</span><span class="p">)</span>

<span class="cm">/*
</span><span class="cm">- 执行栈
</span><span class="cm">  - console.log(&#39;1&#39;) // sync
</span><span class="cm">  - console.log(&#39;5&#39;) // sync
</span><span class="cm">  - console.log(&#39;6&#39;) // then A
</span><span class="cm">  - console.log(&#39;2&#39;) // sync in setTimeout A
</span><span class="cm">  - console.log(&#39;3&#39;) // sync in setTimeout A
</span><span class="cm">  - console.log(&#39;4&#39;) // then B
</span><span class="cm">  - console.log(&#39;7&#39;) // sync in setTimeout B
</span><span class="cm">  - console.log(&#39;8&#39;) // sync in setTimeout B
</span><span class="cm">  - console.log(&#39;9&#39;) // then C
</span><span class="cm">
</span><span class="cm">- 微任务队列
</span><span class="cm">  -[x] then A
</span><span class="cm">  -[x] then B
</span><span class="cm">  -[x] then C
</span><span class="cm">
</span><span class="cm">- 宏任务队列
</span><span class="cm">  -[x] setTimeout A
</span><span class="cm">  -[x] setTimeout B
</span><span class="cm">
</span><span class="cm">* */</span>

</code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="第三题">第三题：</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;script start&#39;</span><span class="p">)</span>

<span class="c1">// setTimeoutA
</span><span class="c1"></span><span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;time1&#39;</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">)</span>

<span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;promise1&#39;</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;promise2&#39;</span><span class="p">)</span>
  <span class="p">})</span>

<span class="kr">async</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">await</span> <span class="nx">bar</span><span class="p">()</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async1 end&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">foo</span><span class="p">()</span>

<span class="kr">async</span> <span class="kd">function</span> <span class="nx">errorFunc</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s1">&#39;error!!!&#39;</span><span class="p">)</span> <span class="c1">// 将 promise 对象的状态锁定为失败
</span><span class="c1"></span>    <span class="c1">// await 之后的代码都是异步执行
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="c1">// 异步微任务 相当于promise.catch
</span><span class="c1"></span>  <span class="p">}</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async1&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s1">&#39;async1 success&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">errorFunc</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">))</span>

<span class="kd">function</span> <span class="nx">bar</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async2 end&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;script end&#39;</span><span class="p">)</span>

</code></pre></td></tr></table>
</div>
</div><ul>
<li>重写代码顺序，函数声明提前
<ul>
<li>声明 async function foo</li>
<li>声明 async function errorFunc</li>
<li>声明 function bar</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// 重写代码顺序
</span><span class="c1"></span><span class="kr">async</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">await</span> <span class="nx">bar</span><span class="p">()</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async1 end&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kr">async</span> <span class="kd">function</span> <span class="nx">errorFunc</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s1">&#39;error!!!&#39;</span><span class="p">)</span> <span class="c1">// 将 promise 对象的状态锁定为失败
</span><span class="c1"></span>    <span class="c1">// await 之后的代码都是异步执行
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="c1">// 异步微任务 相当于promise.catch
</span><span class="c1"></span>  <span class="p">}</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async1&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s1">&#39;async1 success&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">bar</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async2 end&#39;</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;script start&#39;</span><span class="p">)</span>
 
<span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;time1&#39;</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">)</span>

<span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;promise1&#39;</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;promise2&#39;</span><span class="p">)</span>
  <span class="p">})</span>

<span class="nx">foo</span><span class="p">()</span>

<span class="nx">errorFunc</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">))</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;script end&#39;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><ul>
<li>将函数声明带入函数执行位置</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;script start&#39;</span><span class="p">)</span>
 
<span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;time1&#39;</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">)</span>

<span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;promise1&#39;</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;promise2&#39;</span><span class="p">)</span>
  <span class="p">})</span>

<span class="p">(</span><span class="kr">async</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">await</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async2 end&#39;</span><span class="p">)</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async1 end&#39;</span><span class="p">)</span>
<span class="p">})()</span>

<span class="p">(</span><span class="kr">async</span> <span class="kd">function</span> <span class="nx">errorFunc</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s1">&#39;error!!!&#39;</span><span class="p">)</span> <span class="c1">// 将 promise 对象的状态锁定为失败
</span><span class="c1"></span>    <span class="c1">// await 之后的代码都是异步执行
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="c1">// 异步微任务 相当于promise.catch
</span><span class="c1"></span>  <span class="p">}</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async1&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s1">&#39;async1 success&#39;</span><span class="p">)</span>
<span class="p">})()</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">))</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;script end&#39;</span><span class="p">)</span>

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>总结解题顺序</p>
</blockquote>
<ul>
<li>使执行顺序更符合人类阅读顺序</li>
<li>重写代码顺序</li>
<li>将函数声明带入函数执行位置</li>
<li><strong>标记每一个 <code>setTimeoutA B C... </code> <code>thenA B C...</code></strong></li>
<li><strong>标记每一个 <code>setTimeoutA B C... </code> <code>thenA B C...</code></strong></li>
<li><strong>标记每一个 <code>setTimeoutA B C... </code> <code>thenA B C...</code></strong></li>
<li>setTimeout 添加到 Web API 时，注意第二个参数的耗时，影响添加到异步宏任务队列的先后顺序</li>
<li><code>new Promise(Cb)</code> 中的回调 Cb 为同步执行
<ul>
<li>Cb 参数的 <code>resolve</code>和<code>reject</code>执行时机，以<code>resolve</code>为例
<ul>
<li><code>resolve</code>同步执行</li>
<li><code>resolve</code>异步执行
<ul>
<li><code>resolve</code>在异步微任务</li>
<li><code>resolve</code>在异步宏任务</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;script start&#39;</span><span class="p">)</span>

<span class="c1">// setTimeoutA
</span><span class="c1"></span><span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;time1&#39;</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">)</span>

<span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">()</span> <span class="c1">// 同步 将 promise 对象的状态锁定为成功
</span><span class="c1"></span>  <span class="c1">// thenA
</span><span class="c1"></span>  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;promise1&#39;</span><span class="p">)</span>
  <span class="p">})</span> <span class="c1">// 带 thenB 等待promise的状态改变 运行到此时在第二轮微任务队列末尾添加thenB 的微任务
</span><span class="c1"></span>  <span class="c1">// thenB
</span><span class="c1"></span>  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;promise2&#39;</span><span class="p">)</span>
  <span class="p">})</span>

<span class="p">(</span><span class="kr">async</span> <span class="kd">function</span> <span class="nx">foo</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">await</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async2 end&#39;</span><span class="p">)</span> <span class="c1">// 同步 首个await
</span><span class="c1"></span>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async1 end&#39;</span><span class="p">)</span> <span class="c1">// 添加到异步微任务队列
</span><span class="c1"></span><span class="p">})()</span>

<span class="p">(</span><span class="kr">async</span> <span class="kd">function</span> <span class="nx">errorFunc</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kr">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="s1">&#39;error!!!&#39;</span><span class="p">)</span> <span class="c1">// 同步 将 promise 对象的状态锁定为失败
</span><span class="c1"></span>    <span class="c1">// await 之后的代码都是异步执行
</span><span class="c1"></span>  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="c1">// 捕获错误 console.log(error!!!) 添加到异步微任务队列 相当于 promise.catch
</span><span class="c1"></span>  <span class="p">}</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;async1&#39;</span><span class="p">)</span> <span class="c1">// 添加到异步微任务队列
</span><span class="c1"></span>  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s1">&#39;async1 success&#39;</span><span class="p">)</span> <span class="c1">// 异步 将 promise 对象的状态锁定为成功 值为 &#39;async1 success&#39;
</span><span class="c1"></span><span class="p">})()</span> <span class="c1">// 带thenC 运行到此时在第二轮微任务队列末尾添加thenC 的微任务
</span><span class="c1"></span>  <span class="c1">// thenC
</span><span class="c1"></span>  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">res</span> <span class="p">=&gt;</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">res</span><span class="p">))</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;script end&#39;</span><span class="p">)</span>

<span class="cm">/*
</span><span class="cm">- 同步
</span><span class="cm">  - console.log(&#39;script start&#39;);
</span><span class="cm">  - console.log(&#39;async2 end&#39;)
</span><span class="cm">  - console.log(&#39;script end&#39;)
</span><span class="cm">- Web API
</span><span class="cm">  - setTimeoutA 2000ms
</span><span class="cm">- 异步
</span><span class="cm">  - 第一轮微任务队列
</span><span class="cm">    - console.log(&#39;promise1&#39;) // 带 thenB 等待promise的状态改变 运行到此时在第二轮微任务队列末尾添加.then 的微任务
</span><span class="cm">    - console.log(&#39;async1 end&#39;)
</span><span class="cm">    - console.log(&#39;error!!!&#39;)
</span><span class="cm">    - console.log(&#39;async1&#39;) // 带 thenC 等待promise的状态改变 运行到此时在第二轮微任务队列末尾添加.then 的微任务
</span><span class="cm">  - 第二轮微任务队列
</span><span class="cm">    - console.log(&#39;promise2&#39;) // thenB
</span><span class="cm">    - console.log(&#39;async1 success&#39;) // thenC
</span><span class="cm">  - 宏任务队列
</span><span class="cm">    - console.log(&#39;time1&#39;)
</span><span class="cm">* */</span>

<span class="cm">/*
</span><span class="cm">console.log(&#39;script start&#39;);
</span><span class="cm">console.log(&#39;async2 end&#39;)
</span><span class="cm">console.log(&#39;script end&#39;)
</span><span class="cm">console.log(&#39;promise1&#39;)
</span><span class="cm">console.log(&#39;async1 end&#39;)
</span><span class="cm">console.log(&#39;error!!!&#39;)
</span><span class="cm">console.log(&#39;async1&#39;)
</span><span class="cm">console.log(&#39;promise2&#39;)
</span><span class="cm">console.log(&#39;async1 success&#39;)
</span><span class="cm">console.log(&#39;time1&#39;)
</span><span class="cm">* */</span>

<span class="cm">/*
</span><span class="cm">script start
</span><span class="cm">async2 end
</span><span class="cm">script end
</span><span class="cm">promise1
</span><span class="cm">async1 end
</span><span class="cm">error!!!
</span><span class="cm">async1
</span><span class="cm">promise2
</span><span class="cm">async1 success
</span><span class="cm">time1
</span><span class="cm">* */</span>
</code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="第四题">第四题：</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="c1">// setTimeoutA
</span><span class="c1"></span><span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">0</span><span class="p">)</span>

<span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
  <span class="c1">// setTimeoutB
</span><span class="c1"></span>  <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="c1">// setTimeoutB 宏任务完成之后 才锁定 promise 对象状态为成功
</span><span class="c1"></span>    <span class="nx">resolve</span><span class="p">()</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
  <span class="p">},</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">})</span>

<span class="c1">// setTimeoutB 宏任务内部执行完成之后 确定 promise 对象状态为成功 再执行 .then
</span><span class="c1"></span><span class="nx">p</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
  <span class="p">})</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="cm">/*
</span><span class="cm">- 同步
</span><span class="cm">  - console.log(2)
</span><span class="cm">  - console.log(5)
</span><span class="cm">- WEB API
</span><span class="cm">    - setTimeoutA
</span><span class="cm">    - setTimeoutB
</span><span class="cm">- 异步
</span><span class="cm">  - 微
</span><span class="cm">    - 无
</span><span class="cm">  - 宏
</span><span class="cm">    - console.log(1)
</span><span class="cm">    - console.log(3) // setTimeoutB 宏任务完成之后 确定 promise 对象状态为成功 执行 .then
</span><span class="cm">      - 微
</span><span class="cm">        - console.log(4)
</span><span class="cm">* */</span>

<span class="cm">/*
</span><span class="cm">2
</span><span class="cm">5
</span><span class="cm">1
</span><span class="cm">3
</span><span class="cm">4
</span><span class="cm">* */</span>

</code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="第五题">第五题：</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kr">const</span> <span class="nx">p1</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">resolve</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">resolve</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span> <span class="c1">// 同步执行
</span><span class="c1"></span><span class="p">})</span>

<span class="c1">// setTimeoutA
</span><span class="c1"></span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1">// thenA
</span><span class="c1"></span><span class="nx">p1</span>
  <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
  <span class="p">})</span>

<span class="c1">// setTimeoutB
</span><span class="c1"></span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
<span class="p">},</span> <span class="mi">0</span><span class="p">)</span>

<span class="cm">/*
</span><span class="cm">- 同步
</span><span class="cm">  -
</span><span class="cm">- Web API
</span><span class="cm">  - setTimeoutA 10ms
</span><span class="cm">  - setTimeoutB 0ms // 先于 setTimeoutA 将回调添加到宏任务队列
</span><span class="cm">- 异步
</span><span class="cm">  - 微任务
</span><span class="cm">    - thenA // console.log(value) // resolve(&#39;2&#39;) value 为同步执行的结果
</span><span class="cm">      - console.log(2)
</span><span class="cm">  - 宏任务
</span><span class="cm">    - console.log(&#39;3&#39;)
</span><span class="cm">    - console.log(&#39;1&#39;)
</span><span class="cm">* */</span>

<span class="cm">/*
</span><span class="cm">2
</span><span class="cm">3
</span><span class="cm">1
</span><span class="cm">* */</span>

</code></pre></td></tr></table>
</div>
</div><hr>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<hr>
<h3 id="参考文章">参考文章</h3>
<ul>
<li><a href="https://juejin.cn/post/6844903735290757133">关于 async 函数的理解</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/await">await MDN</a></li>
</ul>
<h3 id="相关文章">相关文章</h3>
<ul>
<li>无</li>
</ul>
<hr>
<ul>
<li>作者： Joel</li>
<li>文章链接：</li>
<li><a href="http://xmasuhai.xyz/posts/%E7%89%88%E6%9D%83%E5%A3%B0%E6%98%8E%E9%93%BE%E6%8E%A5/">版权声明</a></li>
<li>非自由转载-非商用-非衍生-保持署名</li>
<li><!-- raw HTML omitted -->河<!-- raw HTML omitted -->
<!-- raw HTML omitted -->掘<!-- raw HTML omitted -->
<!-- raw HTML omitted -->思<!-- raw HTML omitted -->
<!-- raw HTML omitted -->知<!-- raw HTML omitted -->
<!-- raw HTML omitted -->简<!-- raw HTML omitted --></li>
</ul>
<hr>
<hr>

    </div>

    
    
<div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">Joel Xu</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
      2021-12-31
      
        
        
      
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content"><a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">CC BY-NC-ND 4.0</a></span>
  </p>
</div>


    
    

    <footer class="post-footer">
      <div class="post-tags">
          <a href="http://xmasuhai.xyz/tags/frontend/">FrontEnd</a>
          
        </div>

      
      <nav class="post-nav">
        
          <a class="prev" href="/post/http/http%E9%9D%9E%E5%85%A8%E8%A7%A32http%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/">
            
            <i class="iconfont">
              <svg  class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M691.908486 949.511495l75.369571-89.491197c10.963703-12.998035 10.285251-32.864502-1.499144-44.378743L479.499795 515.267417 757.434875 204.940602c11.338233-12.190647 11.035334-32.285311-0.638543-44.850487l-80.46666-86.564541c-11.680017-12.583596-30.356378-12.893658-41.662889-0.716314L257.233596 494.235404c-11.332093 12.183484-11.041474 32.266891 0.657986 44.844348l80.46666 86.564541c1.772366 1.910513 3.706415 3.533476 5.750981 4.877077l306.620399 321.703933C662.505829 963.726242 680.945807 962.528973 691.908486 949.511495z"></path>
</svg>

            </i>
            <span class="prev-text nav-default">【HTTP非全解2】HTTP协议详解</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        
          <a class="next" href="/post/promise/js%E5%BC%82%E6%AD%A5%E9%9D%9E%E5%85%A8%E8%A7%A302asyncawait/">
            <span class="next-text nav-default">【JS异步非全解02】async、await</span>
            <span class="prev-text nav-mobile">下一篇</span>
            
            <i class="iconfont">
              <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="18" height="18">
  <path d="M332.091514 74.487481l-75.369571 89.491197c-10.963703 12.998035-10.285251 32.864502 1.499144 44.378743l286.278095 300.375162L266.565125 819.058374c-11.338233 12.190647-11.035334 32.285311 0.638543 44.850487l80.46666 86.564541c11.680017 12.583596 30.356378 12.893658 41.662889 0.716314l377.434212-421.426145c11.332093-12.183484 11.041474-32.266891-0.657986-44.844348l-80.46666-86.564541c-1.772366-1.910513-3.706415-3.533476-5.750981-4.877077L373.270379 71.774697C361.493148 60.273758 343.054193 61.470003 332.091514 74.487481z"></path>
</svg>

            </i>
          </a>
      </nav>
    </footer>
  </article>

  
  
  
  

  
  

  

  
  

  

  

  

    

  

        </div>
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="icon-links">
  
  
    <a href="mailto:xmasuhai@163.com" rel="me noopener" class="iconfont"
      title="email" >
      <svg class="icon" viewBox="0 0 1451 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M664.781909 681.472759 0 97.881301C0 3.997201 71.046997 0 71.046997 0L474.477909 0 961.649408 0 1361.641813 0C1361.641813 0 1432.688811 3.997201 1432.688811 97.881301L771.345323 681.472759C771.345323 681.472759 764.482731 685.154773 753.594283 688.65053L753.594283 688.664858C741.602731 693.493018 729.424896 695.068979 718.077952 694.839748 706.731093 695.068979 694.553173 693.493018 682.561621 688.664858L682.561621 688.65053C671.644501 685.140446 664.781909 681.472759 664.781909 681.472759L664.781909 681.472759ZM718.063616 811.603883C693.779541 811.016482 658.879232 802.205449 619.10784 767.734955 542.989056 701.759633 0 212.052267 0 212.052267L0 942.809523C0 942.809523 0 1024 83.726336 1024L682.532949 1024 753.579947 1024 1348.948139 1024C1432.688811 1024 1432.688811 942.809523 1432.688811 942.809523L1432.688811 212.052267C1432.688811 212.052267 893.138176 701.759633 817.019477 767.734955 777.248 802.205449 742.347691 811.03081 718.063616 811.603883L718.063616 811.603883Z"></path>
</svg>

    </a>
  
    <a href="https://github.com/xmasuhai" rel="me noopener" class="iconfont"
      title="github"  target="_blank"
      >
      <svg class="icon" style="" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M512 12.672c-282.88 0-512 229.248-512 512 0 226.261333 146.688 418.133333 350.08 485.76 25.6 4.821333 34.986667-11.008 34.986667-24.618667 0-12.16-0.426667-44.373333-0.64-87.04-142.421333 30.890667-172.458667-68.693333-172.458667-68.693333C188.672 770.986667 155.008 755.2 155.008 755.2c-46.378667-31.744 3.584-31.104 3.584-31.104 51.413333 3.584 78.421333 52.736 78.421333 52.736 45.653333 78.293333 119.850667 55.68 149.12 42.581333 4.608-33.109333 17.792-55.68 32.426667-68.48-113.706667-12.8-233.216-56.832-233.216-253.013333 0-55.893333 19.84-101.546667 52.693333-137.386667-5.76-12.928-23.04-64.981333 4.48-135.509333 0 0 42.88-13.738667 140.8 52.48 40.96-11.392 84.48-17.024 128-17.28 43.52 0.256 87.04 5.888 128 17.28 97.28-66.218667 140.16-52.48 140.16-52.48 27.52 70.528 10.24 122.581333 5.12 135.509333 32.64 35.84 52.48 81.493333 52.48 137.386667 0 196.693333-119.68 240-233.6 252.586667 17.92 15.36 34.56 46.762667 34.56 94.72 0 68.522667-0.64 123.562667-0.64 140.202666 0 13.44 8.96 29.44 35.2 24.32C877.44 942.592 1024 750.592 1024 524.672c0-282.752-229.248-512-512-512"></path>
</svg>

    </a>
  
    <a href="https://www.zhihu.com/people/xue-shou-41/posts" rel="me noopener" class="iconfont"
      title="zhihu"  target="_blank"
      >
      <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="36" height="36">
  <path d="M351.791182 562.469462l192.945407 0c0-45.367257-21.3871-71.939449-21.3871-71.939449L355.897709 490.530013c3.977591-82.182744 7.541767-187.659007 8.816806-226.835262l159.282726 0c0 0-0.86367-67.402109-18.578124-67.402109s-279.979646 0-279.979646 0 16.850783-88.141456 39.318494-127.053698c0 0-83.60514-4.510734-112.121614 106.962104S81.344656 355.077018 76.80834 367.390461c-4.536316 12.313443 24.62791 5.832845 36.941354 0 12.313443-5.832845 68.050885-25.924439 84.252893-103.69571l86.570681 0c1.165546 49.28652 4.596691 200.335724 3.515057 226.835262L109.86113 490.530013c-25.275663 18.147312-33.701566 71.939449-33.701566 71.939449L279.868105 562.469462c-8.497535 56.255235-23.417339 128.763642-44.275389 167.210279-33.05279 60.921511-50.55235 116.65793-169.802314 212.576513 0 0-19.442818 14.257725 40.829917 9.073656 60.273758-5.185093 117.305683-20.739347 156.840094-99.807147 20.553105-41.107233 41.805128-93.250824 58.386782-146.138358l-0.055259 0.185218 167.855986 193.263655c0 0 22.035876-51.847855 5.832845-108.880803L371.045711 650.610918l-42.1244 31.157627-0.045025 0.151449c11.69946-41.020252 20.11206-81.5749 22.726607-116.858498C351.665315 564.212152 351.72876 563.345412 351.791182 562.469462z"></path>
  <path d="M584.918753 182.033893l0 668.840094 70.318532 0 28.807093 80.512708 121.875768-80.512708 153.600307 0L959.520453 182.033893 584.918753 182.033893zM887.150192 778.934538l-79.837326 0-99.578949 65.782216-23.537066-65.782216-24.855084 0L659.341766 256.673847l227.807403 0L887.149169 778.934538z"></path>
</svg>

    </a>


<a href="http://xmasuhai.xyz/index.xml" rel="noopener alternate" type="application/rss&#43;xml"
    class="iconfont" title="rss" target="_blank">
    <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="30" height="30">
  <path d="M819.157333 1024C819.157333 574.592 449.408 204.8 0 204.8V0c561.706667 0 1024 462.293333 1024 1024h-204.842667zM140.416 743.04a140.8 140.8 0 0 1 140.501333 140.586667A140.928 140.928 0 0 1 140.074667 1024C62.72 1024 0 961.109333 0 883.626667s62.933333-140.544 140.416-140.586667zM678.784 1024h-199.04c0-263.210667-216.533333-479.786667-479.744-479.786667V345.173333c372.352 0 678.784 306.517333 678.784 678.826667z"></path>
</svg>

  </a>
   
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - <a class="theme-link" href="https://github.com/xianmin/hugo-theme-jane">Jane</a>
  </span>

  <span class="copyright-year">
    &copy;
    
      2019 -
    2022
    <span class="heart">
      
      <i class="iconfont">
        <svg class="icon" viewBox="0 0 1025 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="14" height="14">
  <path d="M1000.1 247.9c-15.5-37.3-37.6-70.6-65.7-98.9-54.4-54.8-125.8-85-201-85-85.7 0-166 39-221.4 107.4C456.6 103 376.3 64 290.6 64c-75.1 0-146.5 30.4-201.1 85.6-28.2 28.5-50.4 61.9-65.8 99.3-16 38.8-24 79.9-23.6 122.2 0.7 91.7 40.1 177.2 108.1 234.8 3.1 2.6 6 5.1 8.9 7.8 14.9 13.4 58 52.8 112.6 102.7 93.5 85.5 209.9 191.9 257.5 234.2 7 6.1 15.8 9.5 24.9 9.5 9.2 0 18.1-3.4 24.9-9.5 34.5-30.7 105.8-95.9 181.4-165 74.2-67.8 150.9-138 195.8-178.2 69.5-57.9 109.6-144.4 109.9-237.3 0.1-42.5-8-83.6-24-122.2z"
   fill="#8a8a8a"></path>
</svg>

      </i>
    </span><span class="author">
        Joel Xu
        
      </span></span>

  
  

  
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont">
        
        <svg class="icon" viewBox="0 0 1024 1024" version="1.1"
  xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"
  width="35" height="35">
  <path d="M510.866688 227.694839 95.449397 629.218702l235.761562 0-2.057869 328.796468 362.40389 0L691.55698 628.188232l241.942331-3.089361L510.866688 227.694839zM63.840492 63.962777l894.052392 0 0 131.813095L63.840492 195.775872 63.840492 63.962777 63.840492 63.962777zM63.840492 63.962777"></path>
</svg>

      </i>
    </div>
  </div>
  
<script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>




<script type="text/javascript" src="/js/main.638251f4230630f0335d8c6748e53a96f94b72670920b60c09a56fdc8bece214.js" integrity="sha256-Y4JR9CMGMPAzXYxnSOU6lvlLcmcJILYMCaVv3Ivs4hQ=" crossorigin="anonymous"></script>












  
    <script type="text/javascript" src="/js/load-photoswipe.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe.min.js"></script>
    <script type="text/javascript" src="/lib/photoswipe/photoswipe-ui-default.min.js"></script>
  















</body>
</html>
